---
title: "SSVEP reward - EEG results"
author: 'Ivan Grahek & Antonio Schettino'
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    theme: default 
editor_options: 
  chunk_output_type: console
---

# About the code

Experiment: FSAReward (Ivan Grahek*, Antonio Schettino*, Ernst Koster, & SÃ¸ren Andersen) (*: co-first authors)
Code written by: Ivan Grahek & Antonio Schettino (2016-2019)
Description: Code for the summary of results of behavioral and EEG data for Experiment 1 of the SSVEP - reward project.  


\newpage

# EEG
## Topography & spectra

![Topography and spectra](Figure4.jpg)
\newpage

## Import data
```{r, warning=FALSE, message=FALSE}
#### Clear the environment and import data #### 

# clear the environment
rm(list=ls())
# clear the console
cat("\014")
#load packages and install them if they're not installed
if (!require("pacman")) install.packages("pacman")
pacman::p_load(reshape2,yarrr,BayesFactor,plyr,ez,schoRsch,brms,knitr,broom, brmstools, BEST, tidyverse, here, HDInterval)
# set seed
set.seed(42)
# Set working directory
#setwd(here())
# import data
data.raw = read.csv(file = here("EEG_preprocessing","grandAverage_amplitudes.csv"),header=TRUE,na.strings="NaN") 

# Rename columns
colnames(data.raw) = c("Subject","Frequency","BslnRedAttendedNomov","BslnBlueAttendedNomov","AcqRedAttendedNomov","AcqBlueAttendedNomov","ExtRedAttendedNomov","ExtBlueAttendedNomov","BslnRedAttendedMov","BslnBlueAttendedMov","AcqRedAttendedMov","AcqBlueAttendedMov","ExtRedAttendedMov","ExtBlueAttendedMov")

# # Reshape to long format - take only no movement trials
data = melt(data.raw,id.vars=c("Subject","Frequency"),
            measure.vars=c("BslnRedAttendedNomov","BslnBlueAttendedNomov","AcqRedAttendedNomov","AcqBlueAttendedNomov","ExtRedAttendedNomov","ExtBlueAttendedNomov","BslnRedAttendedMov","BslnBlueAttendedMov","AcqRedAttendedMov","AcqBlueAttendedMov","ExtRedAttendedMov","ExtBlueAttendedMov"),
            variable.name="Condition",value.name="Amplitude")

# Sort the new dataframe by participant name
data = data[order(data$Subject),]

# Split the variable Condition based on capital letters
data$Condition = gsub("(?!^)(?=[[:upper:]])", " ", data$Condition, perl=T)

# Split the variable condition into multiple variables
Conditions = colsplit(data$Condition, pattern="\\s+",names = c('ExpPhase', 'ColorMoved',"attended","no","moved"))

# Add the variable defining which color is rewarded based on the participant number
data$RewardedColor = ifelse(data$Subject%%2==0,"Blue","Red") # if participant number is even, blue was rewarded

# Add the Conditions needed to the dataset
data$ExpPhase = Conditions[,1]
data$AttendedColor = Conditions[,2]
data$Movement = Conditions[,4]

# Switch the Frequency to the color
data$RecordedFrequency = ifelse(data$Frequency==10,"Blue","Red") # if the recorded frequency is 10Hz assign Blue (color flickering at 10Hz), otherwise assign Red (color flickering at 12Hz)

# Make a new condition based on the attended color and the rewarded color
data$Condition = ifelse(data$AttendedColor==data$RewardedColor, "High_Rew","Low_Rew")

# Make a new condition based on the attended color and the recorded frequency
data$Attention = ifelse(data$AttendedColor==data$RecordedFrequency, "Att","NotAtt")

# Make a new condition based the Condition and the Attention
data$RecordingAndCondition = with(data, paste0(Condition,"_",Attention))

# Select variables which we want to keep
data = subset(data, select=c("Subject","RewardedColor","ExpPhase","AttendedColor","Condition","RecordedFrequency","Attention","RecordingAndCondition","Movement","Amplitude"))

# Sort the data 
data = data[with(data, order(Subject)), ]

# Make a new variable with mean amplitude across all conditions for each participant and each frequency (normalization)
data = ddply(data,.(Subject,RecordedFrequency),transform,
             MeanAmplitude = mean(Amplitude[ExpPhase=="Bsln"],na.rm=TRUE),
             SDAmplitude =   sd(Amplitude,na.rm=TRUE))

# Divide amplitudes in each Subject, Frequency, and Condition by the Mean Amplitude
data$Amplitude = data$Amplitude/data$MeanAmplitude

# Convert variables to be used in analyses into factors
data[c("Subject", "Condition","ExpPhase", "RewardedColor", "Attention", "RecordingAndCondition")] = 
  lapply(data[c("Subject", "Condition","ExpPhase", "RewardedColor", "Attention", "RecordingAndCondition")], factor)

# Save the final data into a new variable
data_all = data
data_all = subset(data_all, Subject!=14)
```


## Analyses
### Means - raw data

```{r, warning=FALSE, message=FALSE}
summary = ddply(data,.(Attention,ExpPhase,Condition),plyr::summarize,Mean=c(paste(round(mean(Amplitude, na.rm = TRUE), digits = 2), " [", round(hdi(Amplitude)[[1]], digits = 2), " ", round(hdi(Amplitude)[[2]], digits = 2), "]")))

names(summary) = c("Attention", "Reward phase", "Reward probability", "Amplitude")

summary$Attention = recode(summary$Attention,
                           "Att" = "Attended",
                           "NotAtt" = "Unattended")

summary$`Reward phase` = recode(summary$`Reward phase`,
                           "Acq" = "Acquisition",
                           "Bsln" = "Baseline",
                           "Ext" = "Extinction")

summary$`Reward probability` = recode(summary$`Reward probability`,
                           "High_Rew" = "High",
                           "Low_Rew" = "Low")

summary = as.data.frame(summary)

summary$`Reward phase` = factor(summary$`Reward phase`, levels = c("Baseline","Acquisition","Extinction"))
summary = summary[order(summary$Attention,summary$`Reward phase`,summary$`Reward probability`),]
row.names(summary) = NULL

kable(summary, caption = "Amplitudes per condition")
```

### Plots - raw data

```{r, warning=FALSE, message=FALSE}
# Plot amplitude across experiment phases------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# prepare data for plotting
dataPlot = data

# rename variables
colnames(dataPlot)[colnames(dataPlot)=="ExpPhase"] <- "Reward phase"
colnames(dataPlot)[colnames(dataPlot)=="Condition"] <- "Reward probability"

# rename conditions
dataPlot$`Reward phase` = recode(dataPlot$`Reward phase`,
                                  "Acq" = "Acquisition",
                                  "Bsln" = "Baseline",
                                  "Ext" = "Extinction")

dataPlot$`Reward probability` = recode(dataPlot$`Reward probability`,
                                        "High_Rew" = "High",
                                        "Low_Rew" = "Low")

#order
dataPlot$`Reward phase` = factor(dataPlot$`Reward phase`, levels = c("Baseline","Acquisition","Extinction"))
dataPlot = dataPlot[order(dataPlot$Attention,dataPlot$`Reward phase`,dataPlot$`Reward probability`),]


plottingConditions = c("Attended","Unattended" )
for (i in 1:length(plottingConditions)){
  
  if(plottingConditions[i]=="Attended"){dataAmplitudePlot=subset(dataPlot,Attention=="Att")}
  
  if(plottingConditions[i]=="Unattended"){dataAmplitudePlot=subset(dataPlot,Attention=="NotAtt")}  

# Pirate plot

    pirateplot(formula = Amplitude ~ `Reward phase` + `Reward probability`, # dependent~independent variables
             data=dataAmplitudePlot, # data frame
             main=plottingConditions[i], # main title
             ylim=c(0.2,2.2), # y-axis: limits
             ylab=expression(paste("Amplitude (",mu,"V)")), # y-axis: label
             theme=0, # preset theme (0: use your own)
             point.col="black", # points: color
             point.o=.3, # points: opacity (0-1)
             avg.line.col="black", # average line: color
             avg.line.lwd=2, # average line: line width
             avg.line.o=1, # average line: opacity (0-1)
             bean.b.col="black", # bean border, color
             bean.lwd=0.6, # bean border, line width
             bean.lty=1, # bean border, line type (1: solid; 2:dashed; 3: dotted; ...)
             bean.b.o=0.3, # bean border, opacity (0-1)
             bean.f.col="gray", # bean filling, color
             bean.f.o=.1, # bean filling, opacity (0-1)
             cap.beans=FALSE, # max and min values of bean densities are capped at the limits found in the data
             gl.col="gray", # gridlines: color
             gl.lty=2, # gridlines: line type (1: solid; 2:dashed; 3: dotted; ...)
             cex.lab=1, # axis labels: size
             cex.axis=1, # axis numbers: size
             cex.names = 1,
             bty="l", # plot box type
             back.col="white") # background, color
}

```

\newpage

### Statistics 

```{r, warning=FALSE, message=FALSE}
# Set the working directory in order to load the models (necessary to download the models from: https://osf.io/kjds3/)
# Set working directory
setwd(here("brms_models"))

model.rewardTimesPhasePlusAtt = readRDS("rewardTimesPhasePlusAtt.EEG.alltrials.rds")
model.full = readRDS("full.EEG.alltrials.rds")
compare.threefactors.EEG.waic = readRDS("compare.EEG.waic.alltrials.rds")
bR2.null.EEG = readRDS("bR2.null.EEG.alltrials")
bR2.expphase.EEG = readRDS("bR2.expphase.EEG.alltrials")
bR2.attention.EEG = readRDS("bR2.attention.EEG.alltrials")
bR2.phaseANDattention.EEG = readRDS("bR2.phaseANDattention.EEG.alltrials")
bR2.phaseANDattention_interaction.EEG = readRDS("bR2.phaseANDattention_interaction.EEG.alltrials")
bR2.rewardTimesPhasePlusAtt.EEG = readRDS("bR2.rewardTimesPhasePlusAtt.EEG.alltrials")
bR2.full.EEG = readRDS("bR2.full.EEG.alltrials")
```

### Model comparison with WAIC

```{r, warning=FALSE, message=FALSE}
print(compare.threefactors.EEG.waic)


```

### Bayesian R squared 

Null model
```{r, warning=FALSE, message=FALSE}
print(bR2.null.EEG)
```

Experiment phase
```{r, warning=FALSE, message=FALSE}
print(bR2.expphase.EEG)
```

Attention model
```{r, warning=FALSE, message=FALSE}
print(bR2.attention.EEG)
```

Phase and attention model
```{r, warning=FALSE, message=FALSE}
print(bR2.phaseANDattention.EEG)
```

Phase and attention interaction model
```{r, warning=FALSE, message=FALSE}
print(bR2.phaseANDattention_interaction.EEG)
```

Reward times phase plus attention model
```{r, warning=FALSE, message=FALSE}
print(bR2.rewardTimesPhasePlusAtt.EEG)
```

Full model
```{r, warning=FALSE, message=FALSE}
print(bR2.full.EEG)
```

### Checking the best model

Plotting the chains
```{r, warning=FALSE, message=FALSE}
# Plot chains
plot(model.rewardTimesPhasePlusAtt, pars = "^b_", ask = FALSE, N=6)
```

Summary of the best model 

```{r, warning=FALSE, message=FALSE}
# Summary of the best model
print(tidy(model.rewardTimesPhasePlusAtt, par_type = "non-varying"), digits = 1)
```

### Plotting the best model

```{r, warning=FALSE, message=FALSE}
post = posterior_samples(model.rewardTimesPhasePlusAtt, "^b")

# Calculate posteriors for each condition

################################################ Baseline ####

##################### Attended

######### High reward
Baseline_High_Attended = post[["b_Intercept"]]
######### Low reward
Baseline_Low_Attended = post[["b_Intercept"]] + 
  post[["b_ConditionLow_Rew"]] 

##################### Not Attended

######### High reward
Baseline_High_NotAttended = post[["b_Intercept"]] + 
  post[["b_AttentionNotAtt"]]
######### Low reward
Baseline_Low_NotAttended = post[["b_Intercept"]] + 
  post[["b_AttentionNotAtt"]] + 
  post[["b_ConditionLow_Rew"]] 

################################################ Acquistion

##################### Attended

######### High reward
Acquisition_High_Attended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] 
######### Low reward
Acquisition_Low_Attended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ConditionLow_Rew:ExpPhaseAcq"]]

##################### Not Attended

######### High reward
Acquisition_High_NotAttended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] + 
  post[["b_AttentionNotAtt"]] 
  
######### Low reward
Acquisition_Low_NotAttended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] + 
  post[["b_AttentionNotAtt"]] + 
  post[["b_ConditionLow_Rew"]] +
  post[["b_ConditionLow_Rew:ExpPhaseAcq"]] 


################################################ Extinction

##################### Attended

######### High reward
Extinction_High_Attended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] 
######### Low reward
Extinction_Low_Attended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ConditionLow_Rew:ExpPhaseExt"]]

##################### Not Attended

######### High reward
Extinction_High_NotAttended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] + 
  post[["b_AttentionNotAtt"]]
######### Low reward
Extinction_Low_NotAttended = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] + 
  post[["b_AttentionNotAtt"]] + 
  post[["b_ConditionLow_Rew"]] +
  post[["b_ConditionLow_Rew:ExpPhaseExt"]] 

```

```{r, warning=FALSE, message=FALSE}

# Data from the model

# make a data frame of conditions from the posterior

posterior_conditions = melt(data.frame(Baseline_High_Attended, Baseline_High_NotAttended, Baseline_Low_Attended, Baseline_Low_NotAttended, Acquisition_High_Attended, Acquisition_High_NotAttended, Acquisition_Low_Attended, Acquisition_Low_NotAttended, Extinction_High_Attended, Extinction_High_NotAttended, Extinction_Low_Attended, Extinction_Low_NotAttended))

posterior_conditions =  posterior_conditions %>% separate(variable, c("Reward Phase", "Reward Probability", "Attention"), "_", extra = "merge")

posterior_conditions$Attention = recode(posterior_conditions$Attention,
                           "Attended" = "Attended",
                           "NotAttended" = "Unattended")

posterior_conditions$Attention  = as.factor(posterior_conditions$Attention )

posterior_conditions$`Reward Probability` = recode(posterior_conditions$`Reward Probability`,
                                      "High" = "High reward probability",
                                      "Low" = "Low reward probability")

posterior_conditions$`Reward Probability` = as.factor(posterior_conditions$`Reward Probability`)

posterior_conditions$`Reward Phase` = recode(posterior_conditions$`Reward Phase`,
                                "Acquisition" = "Training",
                                "Baseline" = "Baseline",
                                "Extinction" = "Test")

posterior_conditions$`Reward Phase` = as.factor(posterior_conditions$`Reward Phase`)

names(posterior_conditions)[4] = "Amplitude"




# Make a table with credible intervals
posterior_means = as.data.frame(c("Attended Baseline High Reward", 
                                  "Unattended Baseline High Reward", 
                                  "Attended Baseline Low Reward",
                                  "Unattended Baseline Low Reward",
                                  
                                  "Attended Acquisition High Reward", 
                                  "Unattended Acquisition High Reward", 
                                  "Attended Acquisition Low Reward",
                                  "Unattended Acquisition Low Reward",
                                  
                                  "Attended Extinction High Reward", 
                                  "Unattended Extinction High Reward", 
                                  "Attended Extinction Low Reward",
                                  "Unattended Extinction Low Reward"))

names(posterior_means)[1] = "Condition"

posterior_means$low_95_CI = c(round(hdi(Baseline_High_Attended)[[1]], digits = 2),
                              round(hdi(Baseline_High_NotAttended)[[1]], digits = 2),
                              round(hdi(Baseline_Low_Attended)[[1]], digits = 2),
                              round(hdi(Baseline_Low_NotAttended)[[1]], digits = 2),
                              round(hdi(Acquisition_High_Attended)[[1]], digits = 2),
                              round(hdi(Acquisition_High_NotAttended)[[1]], digits = 2),
                              round(hdi(Acquisition_Low_Attended)[[1]], digits = 2),
                              round(hdi(Acquisition_Low_NotAttended)[[1]], digits = 2),
                              round(hdi(Extinction_High_Attended)[[1]], digits = 2),
                              round(hdi(Extinction_High_NotAttended)[[1]], digits = 2),
                              round(hdi(Extinction_Low_Attended)[[1]], digits = 2),
                              round(hdi(Extinction_Low_NotAttended)[[1]], digits = 2))

posterior_means$high_95_CI = c(round(hdi(Baseline_High_Attended)[[2]], digits = 2),
                              round(hdi(Baseline_High_NotAttended)[[2]], digits = 2),
                              round(hdi(Baseline_Low_Attended)[[2]], digits = 2),
                              round(hdi(Baseline_Low_NotAttended)[[2]], digits = 2),
                              round(hdi(Acquisition_High_Attended)[[2]], digits = 2),
                              round(hdi(Acquisition_High_NotAttended)[[2]], digits = 2),
                              round(hdi(Acquisition_Low_Attended)[[2]], digits = 2),
                              round(hdi(Acquisition_Low_NotAttended)[[2]], digits = 2),
                              round(hdi(Extinction_High_Attended)[[2]], digits = 2),
                              round(hdi(Extinction_High_NotAttended)[[2]], digits = 2),
                              round(hdi(Extinction_Low_Attended)[[2]], digits = 2),
                              round(hdi(Extinction_Low_NotAttended)[[2]], digits = 2))

posterior_means$low_50_CI = c(round(hdi(Baseline_High_Attended,0.5)[[1]], digits = 2),
                              round(hdi(Baseline_High_NotAttended,0.5)[[1]], digits = 2),
                              round(hdi(Baseline_Low_Attended,0.5)[[1]], digits = 2),
                              round(hdi(Baseline_Low_NotAttended,0.5)[[1]], digits = 2),
                              round(hdi(Acquisition_High_Attended,0.5)[[1]], digits = 2),
                              round(hdi(Acquisition_High_NotAttended,0.5)[[1]], digits = 2),
                              round(hdi(Acquisition_Low_Attended,0.5)[[1]], digits = 2),
                              round(hdi(Acquisition_Low_NotAttended,0.5)[[1]], digits = 2),
                              round(hdi(Extinction_High_Attended,0.5)[[1]], digits = 2),
                              round(hdi(Extinction_High_NotAttended,0.5)[[1]], digits = 2),
                              round(hdi(Extinction_Low_Attended,0.5)[[1]], digits = 2),
                              round(hdi(Extinction_Low_NotAttended,0.5)[[1]], digits = 2))

posterior_means$high_50_CI = c(round(hdi(Baseline_High_Attended,0.5)[[2]], digits = 2),
                              round(hdi(Baseline_High_NotAttended,0.5)[[2]], digits = 2),
                              round(hdi(Baseline_Low_Attended,0.5)[[2]], digits = 2),
                              round(hdi(Baseline_Low_NotAttended,0.5)[[2]], digits = 2),
                              round(hdi(Acquisition_High_Attended,0.5)[[2]], digits = 2),
                              round(hdi(Acquisition_High_NotAttended,0.5)[[2]], digits = 2),
                              round(hdi(Acquisition_Low_Attended,0.5)[[2]], digits = 2),
                              round(hdi(Acquisition_Low_NotAttended,0.5)[[2]], digits = 2),
                              round(hdi(Extinction_High_Attended,0.5)[[2]], digits = 2),
                              round(hdi(Extinction_High_NotAttended,0.5)[[2]], digits = 2),
                              round(hdi(Extinction_Low_Attended,0.5)[[2]], digits = 2),
                              round(hdi(Extinction_Low_NotAttended,0.5)[[2]], digits = 2))


posterior_means =  posterior_means %>% separate(Condition, c("Attention","Reward Phase", "Reward Probability"), " ", extra = "merge")

posterior_means$`Reward Probability` = recode(posterior_means$`Reward Probability`,
                                      "High Reward" = "High reward probability",
                                      "Low Reward" = "Low reward probability")

posterior_means$`Reward Probability`= as.factor(posterior_means$`Reward Probability`)

posterior_means$`Reward Phase` = recode(posterior_means$`Reward Phase`,
                                "Acquisition" = "Training",
                                "Baseline" = "Baseline",
                                "Extinction" = "Test")

posterior_means$`Reward Phase` = as.factor(posterior_means$`Reward Phase`)

posterior_means$Attention = recode(posterior_means$Attention,
                           "Attended" = "Attended",
                           "Unattended" = "Unattended")

posterior_means$Attention = as.factor(posterior_means$Attention)

# Create this variable in order to have it for plotting (this is a quick hack: in plotting the CIs this variable is added and then subtracted)
posterior_means$Amplitude = c(1,1,1,1,1,1,1,1,1,1,1,1)


# Raw data
# Prepare the dataset
# prepare data for plotting - average over motion

dataPlot = data_all
dataPlot = ddply(dataPlot,.(Attention,ExpPhase,Condition,Subject),plyr::summarize,Amplitude=mean(Amplitude, na.rm = TRUE))


# rename variables
colnames(dataPlot)[colnames(dataPlot)=="ExpPhase"] <- "Reward Phase"
colnames(dataPlot)[colnames(dataPlot)=="Condition"] <- "Reward Probability"

# rename conditions
dataPlot$`Reward Phase` = recode(dataPlot$`Reward Phase`,
                                  "Acq" = "Training",
                                  "Bsln" = "Baseline",
                                  "Ext" = "Test")

dataPlot$`Reward Probability` = recode(dataPlot$`Reward Probability`,
                                        "High_Rew" = "High reward probability",
                                        "Low_Rew" = "Low reward probability")

dataPlot$Attention = recode(dataPlot$Attention,
                                        "Att" = "Attended",
                                        "NotAtt" = "Unattended")


##### Plotting targets and distractors separately  #####
  
# # Attended
#   
#   dataAmplitudePlot=subset(dataPlot,Attention=="Attended")
#   posterior_means_plot=subset(posterior_means,Attention=="Attended")
#   posterior_conditions_plot=subset(posterior_conditions,Attention=="Attended")
#   
#   # tiff("ssvep_attended.tiff", units="in", width=8, height=5, res=800)
#     
#   ggplot(data=dataAmplitudePlot, aes(x=`Reward Phase`, y=`Amplitude`, label=`Reward Probability`)) + 
#     # violin of the raw data
#     geom_violin(data=dataAmplitudePlot, color ="#636363",trim = TRUE,alpha="0.2") +
#     # individual participants for the raw data
#     # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
#     geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
#     # mean of the model
#     stat_summary(data = posterior_conditions_plot, aes(x=`Reward Phase`, y=`Amplitude`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
#     # 95 credible intervals of the model
#     geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_95_CI, ymax=`Amplitude`-`Amplitude`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
#     # 50 credible intervals of the model
#     geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_50_CI, ymax=`Amplitude`-`Amplitude`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
#     scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
#     facet_grid(.~`Reward Probability`) + 
#     scale_y_continuous(name="Amplitude (a.u.)",breaks=seq(-1,3,0.5)) +
#     theme(
#       axis.line = element_line(size=1, colour = "black"),
#       panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
#       panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
#       panel.border = element_blank(), 
#       panel.background = element_blank(),
#       plot.title = element_text(size = 12,  face = "bold",hjust = 0.5),
#       text=element_text(colour="black", size = 11),
#       axis.text.x=element_text(colour="black", size = 11),
#       axis.text.y=element_text(colour="black", size = 11),
#       axis.title=element_text(size=12,colour = "black")) + 
#     theme(strip.background =element_rect(fill="white")) + 
#     theme(strip.text = element_text(size = 12))
#   
#   # dev.off()
#   
#   
#   
#   # Unattended
#   
#   dataAmplitudePlot=subset(dataPlot,Attention=="Unattended")
#   posterior_means_plot=subset(posterior_means,Attention=="Unattended")
#   posterior_conditions_plot=subset(posterior_conditions,Attention=="Unattended")
#   
#   # tiff("ssvep_unattended.tiff", units="in", width=8, height=5, res=800)
#     
#   ggplot(data=dataAmplitudePlot, aes(x=`Reward Phase`, y=`Amplitude`, label=`Reward Probability`)) + 
#     # violin of the raw data
#     geom_violin(data=dataAmplitudePlot, color ="#636363",trim = TRUE,alpha="0.2") +
#     # individual participants for the raw data
#     # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
#     geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
#     # mean of the model
#     stat_summary(data = posterior_conditions_plot, aes(x=`Reward Phase`, y=`Amplitude`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
#     # 95 credible intervals of the model
#     geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_95_CI, ymax=`Amplitude`-`Amplitude`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
#     # 50 credible intervals of the model
#     geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_50_CI, ymax=`Amplitude`-`Amplitude`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
#     scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
#     facet_grid(.~`Reward Probability`) + 
#     scale_y_continuous(name="Amplitude (a.u.)",breaks=seq(-1,3,0.5)) +
#     theme(
#       axis.line = element_line(size=1, colour = "black"),
#       panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
#       panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
#       panel.border = element_blank(), 
#       panel.background = element_blank(),
#       plot.title = element_text(size = 12,  face = "bold",hjust = 0.5),
#       text=element_text(colour="black", size = 11),
#       axis.text.x=element_text(colour="black", size = 11),
#       axis.text.y=element_text(colour="black", size = 11),
#       axis.title=element_text(size=12,colour = "black")) + 
#     theme(strip.background =element_rect(fill="white")) + 
#     theme(strip.text = element_text(size = 12))
#   
#   # dev.off()

  
  
##### Plotting high and low separately  #####
  
# High
  
  dataAmplitudePlot=subset(dataPlot,`Reward Probability`=="High reward probability")
  posterior_means_plot=subset(posterior_means,`Reward Probability`=="High reward probability")
  posterior_conditions_plot=subset(posterior_conditions,`Reward Probability`=="High reward probability")
  
  dataPlot$Attention = relevel(dataPlot$Attention,"Attended")
  posterior_conditions$Attention = relevel(posterior_conditions$Attention,"Attended")
  posterior_means$Attention = relevel(posterior_means$Attention,"Attended")
  
  # tiff("ssvep_high.tiff", units="in", width=8, height=5, res=800)
    
f.2.c =   ggplot(data=dataAmplitudePlot, aes(x=`Reward Phase`, y=`Amplitude`, label=Attention)) + 
    # violin of the raw data
    geom_violin(data=dataAmplitudePlot, color ="#636363",trim = TRUE,alpha="0.2") +
    # individual participants for the raw data
    # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
    geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
    # mean of the model
    stat_summary(data = posterior_conditions_plot, aes(x=`Reward Phase`, y=`Amplitude`, group=Attention),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
    # 95 credible intervals of the model
    geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_95_CI, ymax=`Amplitude`-`Amplitude`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
    # 50 credible intervals of the model
    geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_50_CI, ymax=`Amplitude`-`Amplitude`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
    scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
    facet_grid(.~Attention) + 
    scale_y_continuous(name="Amplitude (a.u.)",limits = c(0.6,1.75),breaks=seq(0.6,1.75,0.25)) +
    labs(title="High reward") +
  theme(
    axis.line = element_line(size=1, colour = "black"),
    panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
    text=element_text(colour="black", size = 14),
    axis.text.x=element_text(colour="black", size = 14),
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(size=16,colour = "black")) + 
  theme(strip.background =element_rect(fill="white")) + 
  theme(strip.text = element_text(size = 16))
f.2.c  
  # dev.off()
  
  
  
# Low
  
  dataAmplitudePlot=subset(dataPlot,`Reward Probability`=="Low reward probability")
  posterior_means_plot=subset(posterior_means,`Reward Probability`=="Low reward probability")
  posterior_conditions_plot=subset(posterior_conditions,`Reward Probability`=="Low reward probability")
  
  dataPlot$Attention = relevel(dataPlot$Attention,"Attended")
  posterior_conditions$Attention = relevel(posterior_conditions$Attention,"Attended")
  posterior_means$Attention = relevel(posterior_means$Attention,"Attended")
  
  # tiff("ssvep_low.tiff", units="in", width=8, height=5, res=800)
    
f.2.d =  ggplot(data=dataAmplitudePlot, aes(x=`Reward Phase`, y=`Amplitude`, label=Attention)) + 
    # violin of the raw data
    geom_violin(data=dataAmplitudePlot, color ="#636363",trim = TRUE,alpha="0.2") +
    # individual participants for the raw data
    # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
    geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
    # mean of the model
    stat_summary(data = posterior_conditions_plot, aes(x=`Reward Phase`, y=`Amplitude`, group=Attention),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
    # 95 credible intervals of the model
    geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_95_CI, ymax=`Amplitude`-`Amplitude`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
    # 50 credible intervals of the model
    geom_linerange(data = posterior_means_plot,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_50_CI, ymax=`Amplitude`-`Amplitude`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
    scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
    facet_grid(.~Attention) + 
    scale_y_continuous(name="Amplitude (a.u.)",limits = c(0.6,1.75),breaks=seq(0.6,1.75,0.25)) +
    labs(title="Low reward") +
  theme(
    axis.line = element_line(size=1, colour = "black"),
    panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
    text=element_text(colour="black", size = 14),
    axis.text.x=element_text(colour="black", size = 14),
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(size=16,colour = "black")) + 
  theme(strip.background =element_rect(fill="white")) + 
  theme(strip.text = element_text(size = 16))
f.2.d  
  # dev.off()
####### Plotting everything together #####
  
# # Order for plotting
# # dataPlot$Attention = factor(dataPlot$Attention, levels = c("Target","Distractor")) 
# # posterior_conditions$Attention = factor(posterior_conditions$Attention, levels = c("Target","Distractor")) 
# # posterior_means$Attention = factor(posterior_means$Attention, levels = c("Target","Distractor")) 
# # 
# # dataPlot = dataPlot[order(dataPlot$Attention,dataPlot$`Reward Phase`,dataPlot$`Reward Probability`),]
# 
# dataPlot$Attention = relevel(dataPlot$Attention,"Attended")
# posterior_conditions$Attention = relevel(posterior_conditions$Attention,"Attended")
# posterior_means$Attention = relevel(posterior_means$Attention,"Attended")
# 
# 
#   
#   
#     # tiff("ssvep_both.tiff", units="in", width=16, height=10, res=800)
# 
#     ggplot(data=dataPlot, aes(x=`Reward Phase`, y=`Amplitude`, label=`Reward Probability`)) + 
#     # violin of the raw data
#     geom_violin(data=dataPlot, color ="#636363",trim = TRUE,alpha="0.2") +
#     # individual participants for the raw data
#     # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
#     geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
#     # mean of the model
#     stat_summary(data = posterior_conditions, aes(x=`Reward Phase`, y=`Amplitude`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
#     # 95 credible intervals of the model
#     geom_linerange(data = posterior_means,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_95_CI, ymax=`Amplitude`-`Amplitude`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
#     # 50 credible intervals of the model
#     geom_linerange(data = posterior_means,width=.1, aes(ymin=`Amplitude`-`Amplitude`+low_50_CI, ymax=`Amplitude`-`Amplitude`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
#     scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
#     facet_grid(`Reward Probability`~Attention) + 
#     scale_y_continuous(name="Amplitude (a.u.)",breaks=seq(0.5,2,0.5)) +
#     theme(
#       axis.line = element_line(size=2, colour = "black"),
#       panel.grid.major = element_line(colour = "grey",size = 0.2,linetype = "dashed"),
#       panel.grid.minor = element_line(colour = "grey",size = 0.2,linetype = "dashed"),
#       panel.border = element_blank(), 
#       panel.background = element_blank(),
#       plot.title = element_text(size = 24,  face = "bold",hjust = 0.5),
#       text=element_text(colour="black", size = 22),
#       axis.text.x=element_text(colour="black", size = 22),
#       axis.text.y=element_text(colour="black", size = 22),
#       axis.title=element_text(size=24,colour = "black")) + 
#     theme(strip.background =element_rect(fill="white")) + 
#     theme(strip.text = element_text(size = 24))
# # dev.off()

```

Table of means across conditions

```{r, warning=FALSE, message=FALSE}
# Make a table with conditions
posterior_means = as.data.frame(c("Attended Baseline High Reward", 
                                  "Attended Baseline Low Reward", 
                                  "Attended Acquisition High Reward", 
                                  "Attended Acquisition Low Reward", 
                                  "Attended Extinction High Reward", 
                                  "Attended Extinction Low Reward",
                                  "Unattended Baseline High Reward", 
                                  "Unattended Baseline Low Reward", 
                                  "Unattended Acquisition High Reward", 
                                  "Unattended Acquisition Low Reward", 
                                  "Unattended Extinction High Reward", 
                                  "Unattended Extinction Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$Mean = c(paste(round(mean(Baseline_High_Attended), digits = 2), " [", round(hdi(Baseline_High_Attended)[[1]], digits = 2), " ", round(hdi(Baseline_High_Attended)[[2]], digits = 2), "]"),
                        paste(round(mean(Baseline_Low_Attended), digits = 2), " [", round(hdi(Baseline_Low_Attended)[[1]], digits = 2), " ", round(hdi(Baseline_Low_Attended)[[2]], digits = 2), "]"),
                        
                        paste(round(mean(Acquisition_High_Attended), digits = 2), " [", round(hdi(Acquisition_High_Attended)[[1]], digits = 2), " ", round(hdi(Acquisition_High_Attended)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_Low_Attended), digits = 2), " [", round(hdi(Acquisition_Low_Attended)[[1]], digits = 2), " ", round(hdi(Acquisition_Low_Attended)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_High_Attended), digits = 2), " [", round(hdi(Extinction_High_Attended)[[1]], digits = 2), " ", round(hdi(Extinction_High_Attended)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_Low_Attended), digits = 2), " [", round(hdi(Extinction_Low_Attended)[[1]], digits = 2), " ", round(hdi(Extinction_Low_Attended)[[2]], digits = 2), "]"),
                        paste(round(mean(Baseline_High_NotAttended), digits = 2), " [", round(hdi(Baseline_High_NotAttended)[[1]], digits = 2), " ", round(hdi(Baseline_High_NotAttended)[[2]], digits = 2), "]"),
                        paste(round(mean(Baseline_Low_NotAttended), digits = 2), " [", round(hdi(Baseline_Low_NotAttended)[[1]], digits = 2), " ", round(hdi(Baseline_Low_NotAttended)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_High_NotAttended), digits = 2), " [", round(hdi(Acquisition_High_NotAttended)[[1]], digits = 2), " ", round(hdi(Acquisition_High_NotAttended)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_Low_NotAttended), digits = 2), " [", round(hdi(Acquisition_Low_NotAttended)[[1]], digits = 2), " ", round(hdi(Acquisition_Low_NotAttended)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_High_NotAttended), digits = 2), " [", round(hdi(Extinction_High_NotAttended)[[1]], digits = 2), " ", round(hdi(Extinction_High_NotAttended)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_Low_NotAttended), digits = 2), " [", round(hdi(Extinction_Low_NotAttended)[[1]], digits = 2), " ", round(hdi(Extinction_Low_NotAttended)[[2]], digits = 2), "]"))

names(posterior_means)[2] = "Mean [HDI]"

posterior_means =  posterior_means %>% separate(Condition, c("Attention", "Reward Phase", "Reward Probability"), " ", extra = "merge")

kable(posterior_means, caption = "Means per condition")

```
### Inference about the best model

#### Attended vs. unattended

Check the difference between attended and not attended in baseline high rewarded

```{r, warning=FALSE, message=FALSE}
Diff_Att_NotAtt_Bsln_High = Baseline_High_Attended - Baseline_High_NotAttended
plotPost(Diff_Att_NotAtt_Bsln_High, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
length(Diff_Att_NotAtt_Bsln_High)
```

Check the difference between attended and not attended in baseline low rewarded

```{r, warning=FALSE, message=FALSE}
Diff_Att_NotAtt_Bsln_Low = Baseline_Low_Attended - Baseline_Low_NotAttended
plotPost(Diff_Att_NotAtt_Bsln_Low, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
length(Diff_Att_NotAtt_Bsln_Low)
```

Check the difference between attended and not attended in acquisition high rewarded

```{r, warning=FALSE, message=FALSE}
Diff_Att_NotAtt_Acq_High = Acquisition_High_Attended - Acquisition_High_NotAttended
plotPost(Diff_Att_NotAtt_Acq_High, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
length(Diff_Att_NotAtt_Acq_High)
```

Check the difference between attended and not attended in acquisition low rewarded

```{r, warning=FALSE, message=FALSE}
Diff_Att_NotAtt_Acq_Low = Acquisition_Low_Attended - Acquisition_Low_NotAttended
plotPost(Diff_Att_NotAtt_Acq_Low, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
length(Diff_Att_NotAtt_Acq_Low)
```

Check the difference between attended and not attended in extinction high rewarded

```{r, warning=FALSE, message=FALSE}
Diff_Att_NotAtt_Ext_High = Extinction_High_Attended - Extinction_High_NotAttended
plotPost(Diff_Att_NotAtt_Ext_High, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
length(Diff_Att_NotAtt_Ext_High)
```

Check the difference between attended and not attended in extinction low rewarded

```{r, warning=FALSE, message=FALSE}
Diff_Att_NotAtt_Ext_Low = Extinction_Low_Attended - Extinction_Low_NotAttended
plotPost(Diff_Att_NotAtt_Ext_Low, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

#### Comparison between phases

Check the difference between baseline and acquisition in high reward attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High_Att = Acquisition_High_Attended - Baseline_High_Attended
plotPost(Diff_Bsln_Acq_High_Att, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between baseline and acquisition in low reward attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_Low_Att = Baseline_Low_Attended - Acquisition_Low_Attended
plotPost(Diff_Bsln_Acq_Low_Att, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between baseline and acquisition in high reward not attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High_NotAtt =  Acquisition_High_NotAttended - Baseline_High_NotAttended
plotPost(Diff_Bsln_Acq_High_NotAtt, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between baseline and acquisition in low reward not attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_Low_NotAtt = Acquisition_Low_NotAttended - Baseline_Low_NotAttended  
plotPost(Diff_Bsln_Acq_Low_NotAtt, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between acquisition and extinction in high reward attended

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_High_Att = Acquisition_High_Attended - Extinction_High_Attended
plotPost(Diff_Acq_Ext_High_Att, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between acquisition and extinction in low reward attended

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_Low_Att = Extinction_Low_Attended - Acquisition_Low_Attended 
plotPost(Diff_Acq_Ext_Low_Att, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between acquisition and extinction in high reward not attended

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_High_NotAtt = Extinction_High_NotAttended - Acquisition_High_NotAttended 
plotPost(Diff_Acq_Ext_High_NotAtt, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between acquisition and extinction in low reward not attended

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_Low_NotAtt = Extinction_Low_NotAttended - Acquisition_Low_NotAttended 
plotPost(Diff_Acq_Ext_Low_NotAtt, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

#### Baseline difference

Check the difference between high and low reward in baseline attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_High_Low_Att = Baseline_High_Attended - Baseline_Low_Attended
plotPost(Diff_Bsln_High_Low_Att, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between high and low reward in baseline not attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_High_Low_NotAtt = Baseline_High_NotAttended - Baseline_Low_NotAttended
plotPost(Diff_Bsln_High_Low_NotAtt, xlab = "", col = "#b3cde0", cex = 1, showCurve = FALSE, compVal = 0)
```

Check the difference between baseline and acquisition in high reward unattended vs. attended

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High_vs_Low_in_attended_vs_unattended = Diff_Bsln_High_Low_NotAtt - Diff_Bsln_High_Low_Att 
plotPost(Diff_Bsln_Acq_High_vs_Low_in_attended_vs_unattended, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
paste("Mean = ",round(mean(Diff_Bsln_Acq_High_vs_Low_in_attended_vs_unattended), digits = 2), " [", round(hdi(Diff_Bsln_Acq_High_vs_Low_in_attended_vs_unattended)[[1]], digits = 2), " ", round(hdi(Diff_Bsln_Acq_High_vs_Low_in_attended_vs_unattended)[[2]], digits = 2), "]")
```







# Behavior
## Import data
```{r, warning=FALSE, message=FALSE}
# Clear the environement and import data------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# import data
data.raw = read.csv(file = here("data","Data_behavior_exp1_48pps.csv"),header=TRUE,na.strings="NaN")

# Prepare the dataset------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### Adding and renaming variables 
# rename EventType variable
names(data.raw)[names(data.raw) == "EventType"] = "MovedDots" 
# add a variable with the name of the attended color instead of a numbers
data.raw$AttendedColor = ifelse(data.raw$AttendedColor==1,"red","blue")
# add a variable saying which color was linked with High_Rew (even numbers - blue was High_Rew)
data.raw$RewardedColor = ifelse(data.raw$ParticipantNo%%2==0,"blue","red") 
# add a variable with the name of the moved color instead of a numbers
data.raw$MovedDots = ifelse(data.raw$MovedDots==1,"red","blue") 
# split experimental phases into 6 isntead of 3 phases (trial 0-200: Bsln; trial 201-400: Acq; trial 401-600: Ext)
#data.raw$ExpPhase = cut(data.raw$Trial,breaks=c(0,100,200,300,400,500,600),labels=c("Bsln1","Bsln2","Acq1","Acq2","Ext1","Ext2")) 
# split experimental phases into 3 phases (trial 0-200: Bsln; trial 201-400: Acq; trial 401-600: Ext)
data.raw$ExpPhase = cut(data.raw$Trial,breaks=c(0,200,400,600),labels=c("Bsln","Acq","Ext")) # trial 0-200: Bsln; trial 201-400: Acq; trial 401-600: Ext

### Convert variables to be used in analyses into factors
data.raw[c("ParticipantNo", "AttendedColor","RewardedColor", "MovedDots", "ExpPhase" )] = 
  lapply(data.raw[c("ParticipantNo", "AttendedColor","RewardedColor", "MovedDots", "ExpPhase" )], factor)

### Create variables needed for the accuracy analyses
# count hits, false alarms, misses, correct rejections, and RT separately for each participant (their calculation is done in Matlab: see DataProcessing.m)
data.final = ddply(data.raw,.(ParticipantNo,ExpPhase,AttendedColor,RewardedColor,MovedDots),summarize,
                  numtrials=length(which(Response!=99)), # number of trials per condition (anything that is not 99 or any other number that we're not using)
                  Hits=length(which(Response==1)), # hits: attended color moved, correct response
                  FAs=length(which(Response==2)), # false alarms: attended color did not move, (wrong) response
                  Misses=length(which(Response==0)), # misses: attended color moved, no response
                  CRs=length(which(Response==3)), # correct rejections: attended color did not move, no response
                  mean.RT=mean(RT,na.rm=TRUE)) # mean RT per condition


################################################################## Calculate accuracy and RTs per condition ###############################################################################################################################################################################################################

# Prepare the data------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### Calculate Hits and False alarms
# Hits are calculated for each participant in each condition on trials when they are attending the color that moved. 
# False alarms are  calculated for each participant in each condition on trials when they are attending the color that didn't move (the unattended color moved, but they responded)  
# Here we create the same number of hits & fas for each of the two conditions (moved attended or not)
data.final = ddply(data.final, .(ParticipantNo,ExpPhase,AttendedColor), transform, 
                 Hits = Hits[MovedDots==AttendedColor],
                 FAs = FAs[MovedDots!=AttendedColor])

# Keep only trials on which the attended color moved (we can do behavioral analysis only on those)
data.final = subset(data.final,MovedDots==AttendedColor)

### Calculate d'
# use loglinear transformation: add 0.5 to Hits, FAs, Misses, and CRs (Hautus, 1995, Behavior Research Methods, Instruments, & Computers),
# which is preferred over the 1/2N rule (Macmillan & Kaplan, 1985, Psychological Bulletin) because it results in less biased estimates of d'.
data.final =  ddply(data.final,.(ParticipantNo,ExpPhase,RewardedColor,AttendedColor,numtrials),summarise,
                    tot.Hits=Hits+.5, # hits
                    tot.FAs=FAs+.5, # false alarms
                    tot.Misses=(numtrials-Hits)+.5, # misses
                    tot.CRs=(numtrials-FAs)+.5, # correct rejections
                    Hit.Rate=tot.Hits/(tot.Hits+tot.Misses), # hit rate
                    FA.Rate=tot.FAs/(tot.FAs+tot.CRs), # false alarm rate
                    #dprime=qnorm(Hit.Rate)-qnorm(FA.Rate),
                    Hits.RTs=mean(mean.RT,na.rm=TRUE)) # mean RTs

# Calculate SDT indices with psycho
indices = psycho::dprime(data.final$tot.Hits, data.final$tot.FAs, data.final$tot.Misses, data.final$tot.CRs) 

data.final = cbind(data.final, indices) 
                      

### Create a final dataframe for accuracy and RTs analyses
# add a new variable specifying whether the participant is attending the high or Low_Rewed color
data.final$Condition = ifelse(data.final$RewardedColor==data.final$AttendedColor,"High_Rew","Low_Rew")
# make this variable a factor for further analyses
data.final$Condition = factor(data.final$Condition)

# Exclude subjects without EEG
missing_eeg = c(5,10,13,27,14)
data.final = data.final[!data.final$ParticipantNo %in% missing_eeg,]

```
## D prime
### Means - D prime - raw data

```{r, warning=FALSE, message=FALSE}
summary = ddply(data.final,.(ExpPhase,Condition),plyr::summarize,Mean=c(paste(round(mean(dprime, na.rm = TRUE), digits = 2), " [", round(hdi(dprime)[[1]], digits = 2), " ", round(hdi(dprime)[[2]], digits = 2), "]")))

names(summary) = c("Reward phase", "Reward probability", "Dprime")

summary$`Reward phase` = recode(summary$`Reward phase`,
                           "Acq" = "Acquisition",
                           "Bsln" = "Baseline",
                           "Ext" = "Extinction")

summary$`Reward probability` = recode(summary$`Reward probability`,
                           "High_Rew" = "High",
                           "Low_Rew" = "Low")

summary = as.data.frame(summary)

kable(summary, caption = "Dprime per condition")
```

### Plot

```{r, warning=FALSE, message=FALSE}
# # Plot FA rates------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] <- "Reward phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] <- "Reward probability"

# rename conditions
data.plot$`Reward phase` = recode(data.plot$`Reward phase`,
                                "Acq" = "Acquisition",
                                "Bsln" = "Baseline",
                                "Ext" = "Extinction")

data.plot$`Reward probability` = recode(data.plot$`Reward probability`,
                                      "High_Rew" = "High",
                                      "Low_Rew" = "Low")
  # Pirate plot
  pirateplot(formula=dprime ~ `Reward phase` + `Reward probability`, # dependent~independent variables
             data=data.plot, # data frame
             main="Dprime", # main title
             ylim=c(-2,4), # y-axis: limits
             ylab="Dprime", # y-axis: label
             theme=0, # preset theme (0: use your own)
             point.col="black", # points: color
             point.o=.3, # points: opacity (0-1)
             avg.line.fun = median,
             avg.line.col="black", # average line: color
             avg.line.lwd=2, # average line: line width
             avg.line.o=1, # average line: opacity (0-1)
             bean.b.col="black", # bean border, color
             bean.lwd=0.6, # bean border, line width
             bean.lty=1, # bean border, line type (1: solid; 2:dashed; 3: dotted; ...)
             bean.b.o=0.3, # bean border, opacity (0-1)
             bean.f.col="gray", # bean filling, color
             bean.f.o=.1, # bean filling, opacity (0-1)
             cap.beans=FALSE, # max and min values of bean densities are capped at the limits found in the data
             gl.col="gray", # gridlines: color
             gl.lty=2, # gridlines: line type (1: solid; 2:dashed; 3: dotted; ...)
             cex.lab=1, # axis labels: size
             cex.axis=1, # axis numbers: size
             cex.names = 1,
             bty="l", # plot box type
             back.col="white") # background, color
  
```

\newpage

### Statistics 

```{r, warning=FALSE, message=FALSE}
# Set the working directory in order to load the models
# Set working directory
setwd(here("brms_models"))


model.full.Acc.dprime = readRDS("model.full.Acc.dprime.rds")
compare.waic.Acc.dprime = readRDS("compare.Acc.dprime.waic")
compare.Acc.dprime.waic.weights = readRDS("compare.Acc.dprime.waic.weights")
bR2.null.Acc.dprime = readRDS("bR2.null.Acc.dprime")
bR2.expphase.Acc.dprime = readRDS("bR2.expphase.Acc.dprime")
bR2.full.Acc.dprime = readRDS("bR2.full.Acc.dprime")
```

### Model comparison with WAIC

```{r, warning=FALSE, message=FALSE}
print(compare.waic.Acc.dprime)
```



### Bayesian R squared 

Null model
```{r, warning=FALSE, message=FALSE}
print(bR2.null.Acc.dprime)
```

Experiment phase model
```{r, warning=FALSE, message=FALSE}
print(bR2.expphase.Acc.dprime)
```

Full model
```{r, warning=FALSE, message=FALSE}
print(bR2.full.Acc.dprime)
```

### Checking the best model

Plotting the chains
```{r, warning=FALSE, message=FALSE}
# Plot chains
plot(model.full.Acc.dprime, pars = "^b_", ask = FALSE, N=6)
```

Summary of the best model 

```{r, warning=FALSE, message=FALSE}
# Summary of the best model
print(tidy(model.full.Acc.dprime, par_type = "non-varying"), digits = 1)
```

### Plotting the best model
#### Sample from the posterior
```{r, warning=FALSE, message=FALSE}
# Analyzing the posterior and differences between conditions

post = posterior_samples(model.full.Acc.dprime, "^b")


################################################ Baseline ####

######### High reward
Baseline_High = post[["b_Intercept"]]
######### Low reward
Baseline_Low = post[["b_Intercept"]] + 
  post[["b_ConditionLow_Rew"]] 

################################################ Acquistion

######### High reward
Acquisition_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] 
######### Low reward
Acquisition_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseAcq:ConditionLow_Rew"]]

################################################ Extinction

######### High reward
Extinction_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] 
######### Low reward
Extinction_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseExt:ConditionLow_Rew"]]
```

```{r, warning=FALSE, message=FALSE}

# Data from the model

# make a data frame of conditions from the posterior
posterior_conditions = melt(data.frame(Baseline_High, Baseline_Low, Acquisition_High, Acquisition_Low, Extinction_High, Extinction_Low))

posterior_conditions =  posterior_conditions %>% separate(variable, c("Reward Phase", "Reward Probability"), "_", extra = "merge")

names(posterior_conditions)[3] = "dprime"

posterior_conditions$`Reward Probability` = recode(posterior_conditions$`Reward Probability`,
                                      "High" = "High reward",
                                      "Low" = "Low reward")


posterior_conditions$`Reward Phase` = recode(posterior_conditions$`Reward Phase`,
                                "Acquisition" = "Training",
                                "Baseline" = "Baseline",
                                "Extinction" = "Test")


# Make a table with credible intervals
posterior_means = as.data.frame(c("Baseline High Reward", 
                                  "Baseline Low Reward", 
                                  "Acquisition High Reward", 
                                  "Acquisition Low Reward", 
                                  "Extinction High Reward", 
                                  "Extinction Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$low_95_CI = c(round(hdi(Baseline_High)[[1]], digits = 2),
                        round(hdi(Baseline_Low)[[1]], digits = 2),
                        round(hdi(Acquisition_High)[[1]], digits = 2),
                        round(hdi(Acquisition_Low)[[1]], digits = 2),
                        round(hdi(Extinction_High)[[1]], digits = 2),
                        round(hdi(Extinction_Low)[[1]], digits = 2))

posterior_means$high_95_CI = c(round(hdi(Baseline_High)[[2]], digits = 2),
                        round(hdi(Baseline_Low)[[2]], digits = 2),
                        round(hdi(Acquisition_High)[[2]], digits = 2),
                        round(hdi(Acquisition_Low)[[2]], digits = 2),
                        round(hdi(Extinction_High)[[2]], digits = 2),
                        round(hdi(Extinction_Low)[[2]], digits = 2))

posterior_means$low_50_CI = c(round(hdi(Baseline_High,0.5)[[1]], digits = 2),
                        round(hdi(Baseline_Low,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition_High,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition_Low,0.5)[[1]], digits = 2),
                        round(hdi(Extinction_High,0.5)[[1]], digits = 2),
                        round(hdi(Extinction_Low,0.5)[[1]], digits = 2))

posterior_means$high_50_CI = c(round(hdi(Baseline_High,0.5)[[2]], digits = 2),
                        round(hdi(Baseline_Low,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition_High,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition_Low,0.5)[[2]], digits = 2),
                        round(hdi(Extinction_High,0.5)[[2]], digits = 2),
                        round(hdi(Extinction_Low,0.5)[[2]], digits = 2))

posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")

posterior_means$`Reward Probability` = recode(posterior_means$`Reward Probability`,
                                      "High Reward" = "High reward",
                                      "Low Reward" = "Low reward")

posterior_means$`Reward Phase` = recode(posterior_means$`Reward Phase`,
                                "Acquisition" = "Training",
                                "Baseline" = "Baseline",
                                "Extinction" = "Test")

# Create this variable in order to have it for plotting (this is a quick hack: in plotting the CIs this variable is added and then subtracted)
posterior_means$`dprime` = c(1,1,1,1,1,1)


# Raw data
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] = "Reward Phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] = "Reward Probability"

# rename conditions
data.plot$`Reward Phase` = recode(data.plot$`Reward Phase`,
                                "Acq" = "Training",
                                "Bsln" = "Baseline",
                                "Ext" = "Test")

data.plot$`Reward Probability` = recode(data.plot$`Reward Probability`,
                                      "High_Rew" = "High reward",
                                      "Low_Rew" = "Low reward")


# Violin + the model
# tiff("dprime.tiff", units="in", width=8, height=5, res=800)

f.2.a = ggplot(data=data.plot, aes(x=`Reward Phase`, y=`dprime`, label=`Reward Probability`)) + 
  # violin of the raw data
  geom_violin(data=data.plot, color ="#636363",trim = TRUE,alpha="0.2") +
  # individual participants for the raw data
  # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
  geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
  # mean of the model
  stat_summary(data = posterior_conditions, aes(x=`Reward Phase`, y=`dprime`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
  # 95 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`dprime`-`dprime`+low_95_CI, ymax=`dprime`-`dprime`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
  # 50 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`dprime`-`dprime`+low_50_CI, ymax=`dprime`-`dprime`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
  scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
  facet_grid(.~`Reward Probability`) + 
  scale_y_continuous(limits = c(-1,3),breaks=seq(-1,3,0.5)) +
  labs(title="Sensitivity dâ²", y = "Sensitivity dâ²") + 
  theme(
    axis.line = element_line(size=1, colour = "black"),
    panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
    text=element_text(colour="black", size = 14),
    axis.text.x=element_text(colour="black", size = 14),
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(size=16,colour = "black")) + 
  theme(strip.background =element_rect(fill="white")) + 
  theme(strip.text = element_text(size = 16))
f.2.a
# dev.off()



```

Table of means across conditions

```{r, warning=FALSE, message=FALSE}
library(HDInterval)

# Make a table with conditions
posterior_means = as.data.frame(c("Baseline High Reward", 
                                  "Baseline Low Reward", 
                                  "Acquisition High Reward", 
                                  "Acquisition Low Reward", 
                                  "Extinction High Reward", 
                                  "Extinction Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$Mean = c(paste(round(mean(Baseline_High), digits = 2), " [", round(hdi(Baseline_High)[[1]], digits = 2), " ", round(hdi(Baseline_High)[[2]], digits = 2), "]"),
                        paste(round(mean(Baseline_Low), digits = 2), " [", round(hdi(Baseline_Low)[[1]], digits = 2), " ", round(hdi(Baseline_Low)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_High), digits = 2), " [", round(hdi(Acquisition_High)[[1]], digits = 2), " ", round(hdi(Acquisition_High)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_Low), digits = 2), " [", round(hdi(Acquisition_Low)[[1]], digits = 2), " ", round(hdi(Acquisition_Low)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_High), digits = 2), " [", round(hdi(Extinction_High)[[1]], digits = 2), " ", round(hdi(Extinction_High)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_Low), digits = 2), " [", round(hdi(Extinction_Low)[[1]], digits = 2), " ", round(hdi(Extinction_Low)[[2]], digits = 2), "]"))

names(posterior_means)[2] = "Mean [HDI]"

posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")
                        
kable(posterior_means, caption = "Means per condition")

```

### Inference about the best model

Check the difference between high reward in baseline vs. acquisition 

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High = Acquisition_High - Baseline_High
plotPost(Diff_Bsln_Acq_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Bsln_Acq_High)
```

Check the difference between low reward in baseline vs. acquisition 

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_Low = Acquisition_Low - Baseline_Low
plotPost(Diff_Bsln_Acq_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Bsln_Acq_Low)
```

Check the difference between high and low reward in baseline vs. acquisition 

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High_vs_Low = Diff_Bsln_Acq_Low - Diff_Bsln_Acq_High 
plotPost(Diff_Bsln_Acq_High_vs_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
paste("Mean = ",round(mean(Diff_Bsln_Acq_High_vs_Low), digits = 2), " [", round(hdi(Diff_Bsln_Acq_High_vs_Low)[[1]], digits = 2), " ", round(hdi(Diff_Bsln_Acq_High_vs_Low)[[2]], digits = 2), "]")
length(Diff_Bsln_Acq_High_vs_Low)
```


Check the difference between high reward in acquisition vs. extinction 

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_High = Extinction_High - Acquisition_High
plotPost(Diff_Acq_Ext_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Acq_Ext_High)
```

Check the difference between low reward in acquisition vs. extinction 

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_Low = Extinction_Low - Acquisition_Low
plotPost(Diff_Acq_Ext_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Acq_Ext_Low)
```

## Reaction times

### Means - raw data

```{r, warning=FALSE, message=FALSE}
summary = ddply(data.final,.(ExpPhase,Condition),plyr::summarize,Mean=c(paste(round(mean(Hits.RTs, na.rm = TRUE), digits = 2), " [", round(hdi(Hits.RTs)[[1]], digits = 2), " ", round(hdi(Hits.RTs)[[2]], digits = 2), "]")))

names(summary) = c("Reward phase", "Reward probability", "Reaction times")

summary$`Reward phase` = recode(summary$`Reward phase`,
                           "Acq" = "Acquisition",
                           "Bsln" = "Baseline",
                           "Ext" = "Extinction")

summary$`Reward probability` = recode(summary$`Reward probability`,
                           "High_Rew" = "High",
                           "Low_Rew" = "Low")

summary = as.data.frame(summary)

kable(summary, caption = "Reaction times per condition")
```

### Plot

```{r, warning=FALSE, message=FALSE}
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] = "Reward phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] = "Reward probability"

# rename conditions
data.plot$`Reward phase` = recode(data.plot$`Reward phase`,
                                "Acq" = "Acquisition",
                                "Bsln" = "Baseline",
                                "Ext" = "Extinction")

data.plot$`Reward probability` = recode(data.plot$`Reward probability`,
                                      "High_Rew" = "High",
                                      "Low_Rew" = "Low")

# Pirate plot
  pirateplot(formula = Hits.RTs ~ `Reward phase` + `Reward probability`, # dependent~independent variables
             data=data.plot, # data frame
             main="Reaction times", # main title
             ylim=c(400,700), # y-axis: limits
             ylab="Reaction time", # y-axis: label
             theme=0, # preset theme (0: use your own)
             point.col="black", # points: color
             point.o=.3, # points: opacity (0-1)
             avg.line.fun = median,
             avg.line.col="black", # average line: color
             avg.line.lwd=2, # average line: line width
             avg.line.o=1, # average line: opacity (0-1)
             bean.b.col="black", # bean border, color
             bean.lwd=0.6, # bean border, line width
             bean.lty=1, # bean border, line type (1: solid; 2:dashed; 3: dotted; ...)
             bean.b.o=0.3, # bean border, opacity (0-1)
             bean.f.col="gray", # bean filling, color
             bean.f.o=.1, # bean filling, opacity (0-1)
             cap.beans=FALSE, # max and min values of bean densities are capped at the limits found in the data
             gl.col="gray", # gridlines: color
             gl.lty=2, # gridlines: line type (1: solid; 2:dashed; 3: dotted; ...)
             cex.lab=1, # axis labels: size
             cex.axis=1, # axis numbers: size
             cex.names = 1,
             bty="l", # plot box type
             back.col="white") # background, color
```

### Statistics
```{r, warning=FALSE, message=FALSE}
# Set the working directory in order to load the models
# Set working directory
setwd(here("brms_models"))

model.full.RT = readRDS("model.full.RT.rds")
compare.waic.RT = readRDS("compare.RT.waic")
compare.RT.waic.weights = readRDS("compare.RT.waic.weights")
bR2.null.RT = readRDS("bR2.null.RT")
bR2.expphase.RT = readRDS("bR2.expphase.RT")
bR2.full.RT = readRDS("bR2.full.RT")
```

### Model comparison with WAIC

```{r, warning=FALSE, message=FALSE}
print(compare.waic.RT)
```

### Bayesian R squared 

Null model
```{r, warning=FALSE, message=FALSE}
print(bR2.null.RT)
```

Experiment phase model
```{r, warning=FALSE, message=FALSE}
print(bR2.expphase.RT)
```

Full model
```{r, warning=FALSE, message=FALSE}
print(bR2.full.RT)
```

### Checking the best model

Plotting the chains
```{r, warning=FALSE, message=FALSE}
# Plot chains
plot(model.full.RT, pars = "^b_", ask = FALSE, N=6)
```

Summary of the best model 

```{r, warning=FALSE, message=FALSE}
# Summary of the best model
print(tidy(model.full.RT, par_type = "non-varying"), digits = 1)
```


### Plotting the best model
#### Sample from the posterior
```{r, warning=FALSE, message=FALSE}

# Analyzing the posterior and differences between conditions

post = posterior_samples(model.full.RT, "^b")


################################################ Baseline ####

######### High reward
Baseline_High = post[["b_Intercept"]]
######### Low reward
Baseline_Low = post[["b_Intercept"]] + 
  post[["b_ConditionLow_Rew"]] 

################################################ Acquistion

######### High reward
Acquisition_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] 
######### Low reward
Acquisition_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseAcq:ConditionLow_Rew"]]

################################################ Extinction

######### High reward
Extinction_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] 
######### Low reward
Extinction_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseExt:ConditionLow_Rew"]]
```

```{r, warning=FALSE, message=FALSE}
# Data from the model

# make a data frame of conditions from the posterior
posterior_conditions = melt(data.frame(Baseline_High, Baseline_Low, Acquisition_High, Acquisition_Low, Extinction_High, Extinction_Low))

posterior_conditions =  posterior_conditions %>% separate(variable, c("Reward Phase", "Reward Probability"), "_", extra = "merge")

names(posterior_conditions)[3] = "Reaction time"

posterior_conditions$`Reward Probability` = recode(posterior_conditions$`Reward Probability`,
                                      "High" = "High reward",
                                      "Low" = "Low reward")

posterior_conditions$`Reward Phase` = recode(posterior_conditions$`Reward Phase`,
                                "Acquisition" = "Training",
                                "Baseline" = "Baseline",
                                "Extinction" = "Test")


# Make a table with credible intervals
posterior_means = as.data.frame(c("Baseline High Reward", 
                                  "Baseline Low Reward", 
                                  "Acquisition High Reward", 
                                  "Acquisition Low Reward", 
                                  "Extinction High Reward", 
                                  "Extinction Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$low_95_CI = c(round(hdi(Baseline_High)[[1]], digits = 2),
                        round(hdi(Baseline_Low)[[1]], digits = 2),
                        round(hdi(Acquisition_High)[[1]], digits = 2),
                        round(hdi(Acquisition_Low)[[1]], digits = 2),
                        round(hdi(Extinction_High)[[1]], digits = 2),
                        round(hdi(Extinction_Low)[[1]], digits = 2))

posterior_means$high_95_CI = c(round(hdi(Baseline_High)[[2]], digits = 2),
                        round(hdi(Baseline_Low)[[2]], digits = 2),
                        round(hdi(Acquisition_High)[[2]], digits = 2),
                        round(hdi(Acquisition_Low)[[2]], digits = 2),
                        round(hdi(Extinction_High)[[2]], digits = 2),
                        round(hdi(Extinction_Low)[[2]], digits = 2))

posterior_means$low_50_CI = c(round(hdi(Baseline_High,0.5)[[1]], digits = 2),
                        round(hdi(Baseline_Low,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition_High,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition_Low,0.5)[[1]], digits = 2),
                        round(hdi(Extinction_High,0.5)[[1]], digits = 2),
                        round(hdi(Extinction_Low,0.5)[[1]], digits = 2))

posterior_means$high_50_CI = c(round(hdi(Baseline_High,0.5)[[2]], digits = 2),
                        round(hdi(Baseline_Low,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition_High,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition_Low,0.5)[[2]], digits = 2),
                        round(hdi(Extinction_High,0.5)[[2]], digits = 2),
                        round(hdi(Extinction_Low,0.5)[[2]], digits = 2))

posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")

posterior_means$`Reward Probability` = recode(posterior_means$`Reward Probability`,
                                      "High Reward" = "High reward",
                                      "Low Reward" = "Low reward")

posterior_means$`Reward Phase` = recode(posterior_means$`Reward Phase`,
                                "Acquisition" = "Training",
                                "Baseline" = "Baseline",
                                "Extinction" = "Test")

# Create this variable in order to have it for plotting (this is a quick hack: in plotting the CIs this variable is added and then subtracted)
posterior_means$`Reaction time` = c(555,555,555,555,555,555)


# Raw data
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] = "Reward Phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] = "Reward Probability"

# rename conditions
data.plot$`Reward Phase` = recode(data.plot$`Reward Phase`,
                                "Acq" = "Training",
                                "Bsln" = "Baseline",
                                "Ext" = "Test")

data.plot$`Reward Probability` = recode(data.plot$`Reward Probability`,
                                      "High_Rew" = "High reward",
                                      "Low_Rew" = "Low reward")

data.plot$`Reaction time` = data.plot$Hits.RTs


# Violin + the model
# tiff("RTs.tiff", units="in", width=8, height=5, res=800)

f.2.b = ggplot(data=data.plot, aes(x=`Reward Phase`, y=`Reaction time`, label=`Reward Probability`)) + 
  # violin of the raw data
  geom_violin(data=data.plot, color ="#636363",trim = TRUE,alpha="0.2") +
  # individual participants for the raw data
  # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
  geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
  # mean of the model
  stat_summary(data = posterior_conditions, aes(x=`Reward Phase`, y=`Reaction time`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
  # 95 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`Reaction time`-`Reaction time`+low_95_CI, ymax=`Reaction time`-`Reaction time`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
  # 50 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`Reaction time`-`Reaction time`+low_50_CI, ymax=`Reaction time`-`Reaction time`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
  scale_x_discrete(limits=c("Baseline", "Training", "Test")) +
  facet_grid(.~`Reward Probability`) + 
  scale_y_continuous(limits = c(450,650), breaks=seq(450,650,50)) +
  labs(title="Reaction time", y = "Reaction time (ms)") + 
  theme(
    axis.line = element_line(size=1, colour = "black"),
    panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
    text=element_text(colour="black", size = 14),
    axis.text.x=element_text(colour="black", size = 14),
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(size=16,colour = "black")) + 
  theme(strip.background =element_rect(fill="white")) + 
  theme(strip.text = element_text(size = 16))
f.2.b 
# dev.off()



```


Table of means across conditions

```{r, warning=FALSE, message=FALSE}
library(HDInterval)

# Make a table with conditions
posterior_means = as.data.frame(c("Baseline High Reward", 
                                  "Baseline Low Reward", 
                                  "Acquisition High Reward", 
                                  "Acquisition Low Reward", 
                                  "Extinction High Reward", 
                                  "Extinction Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$Mean = c(paste(round(mean(Baseline_High), digits = 2), " [", round(hdi(Baseline_High)[[1]], digits = 2), " ", round(hdi(Baseline_High)[[2]], digits = 2), "]"),
                        paste(round(mean(Baseline_Low), digits = 2), " [", round(hdi(Baseline_Low)[[1]], digits = 2), " ", round(hdi(Baseline_Low)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_High), digits = 2), " [", round(hdi(Acquisition_High)[[1]], digits = 2), " ", round(hdi(Acquisition_High)[[2]], digits = 2), "]"),
                        paste(round(mean(Acquisition_Low), digits = 2), " [", round(hdi(Acquisition_Low)[[1]], digits = 2), " ", round(hdi(Acquisition_Low)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_High), digits = 2), " [", round(hdi(Extinction_High)[[1]], digits = 2), " ", round(hdi(Extinction_High)[[2]], digits = 2), "]"),
                        paste(round(mean(Extinction_Low), digits = 2), " [", round(hdi(Extinction_Low)[[1]], digits = 2), " ", round(hdi(Extinction_Low)[[2]], digits = 2), "]"))

names(posterior_means)[2] = "Mean [HDI]"

posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")

kable(posterior_means, caption = "Means per condition")
```

### Inference about the best model

Check the difference between high reward in baseline vs. acquisition 

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High = Acquisition_High - Baseline_High
plotPost(Diff_Bsln_Acq_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Bsln_Acq_High)
```

Check the difference between low reward in baseline vs. acquisition 

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_Low = Acquisition_Low - Baseline_Low 
plotPost(Diff_Bsln_Acq_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Bsln_Acq_Low)
```

Check the difference between high and low reward in baseline vs. acquisition 

```{r, warning=FALSE, message=FALSE}
Diff_Bsln_Acq_High_vs_Low = Diff_Bsln_Acq_High - Diff_Bsln_Acq_Low 
plotPost(Diff_Bsln_Acq_High_vs_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
paste("Mean = ",round(mean(Diff_Bsln_Acq_High_vs_Low), digits = 2), " [", round(hdi(Diff_Bsln_Acq_High_vs_Low)[[1]], digits = 2), " ", round(hdi(Diff_Bsln_Acq_High_vs_Low)[[2]], digits = 2), "]")
length(Diff_Bsln_Acq_High_vs_Low)
```

Check the difference between high reward in acquisition vs. extinction 

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_High = Extinction_High - Acquisition_High
plotPost(Diff_Acq_Ext_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Acq_Ext_High)
```

Check the difference between low reward in acquisition vs. extinction 

```{r, warning=FALSE, message=FALSE}
Diff_Acq_Ext_Low = Extinction_Low - Acquisition_Low
plotPost(Diff_Acq_Ext_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
length(Diff_Acq_Ext_Low)
```

# Behavior - splitting the phases
## Import data
```{r, warning=FALSE, message=FALSE}
# Clear environemnt and import data------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# # clear the environment
# rm(list=ls()) 
# # clear the console
# cat("\014") 
# #load packages and install them if they're not installed
# if (!require("pacman")) install.packages("pacman")
# pacman::p_load(plyr,Rmisc,yarrr,BayesFactor,reshape2,brms, broom, tidyverse, brmstools, BEST, knitr, here,psych)
# # set seed
# set.seed(42) 
# # set directory
# setwd(here())
# import data
data.raw = read.csv(file = here("data","Data_behavior_exp1_48pps.csv"),header=TRUE,na.strings="NaN")

# Prepare the dataset------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### Adding and renaming variables 
# rename EventType variable
names(data.raw)[names(data.raw) == "EventType"] = "MovedDots" 
# add a variable with the name of the attended color instead of a numbers
data.raw$AttendedColor = ifelse(data.raw$AttendedColor==1,"red","blue")
# add a variable saying which color was linked with High_Rew (even numbers - blue was High_Rew)
data.raw$RewardedColor = ifelse(data.raw$ParticipantNo%%2==0,"blue","red") 
# add a variable with the name of the moved color instead of a numbers
data.raw$MovedDots = ifelse(data.raw$MovedDots==1,"red","blue") 
# split experimental phases into 6 isntead of 3 phases (trial 0-200: Bsln; trial 201-400: Acq; trial 401-600: Ext)
data.raw$ExpPhase = cut(data.raw$Trial,breaks=c(0,100,200,300,400,500,600),labels=c("Bsln1","Bsln2","Acq1","Acq2","Ext1","Ext2"))
# split experimental phases into 3 phases (trial 0-200: Bsln; trial 201-400: Acq; trial 401-600: Ext)
# data.raw$ExpPhase = cut(data.raw$Trial,breaks=c(0,200,400,600),labels=c("Bsln","Acq","Ext")) # trial 0-200: Bsln; trial 201-400: Acq; trial 401-600: Ext

### Convert variables to be used in analyses into factors
data.raw[c("ParticipantNo", "AttendedColor","RewardedColor", "MovedDots", "ExpPhase" )] = 
  lapply(data.raw[c("ParticipantNo", "AttendedColor","RewardedColor", "MovedDots", "ExpPhase" )], factor)

### Create variables needed for the accuracy analyses
# count hits, false alarms, misses, correct rejections, and RT separately for each participant (their calculation is done in Matlab: see DataProcessing.m)
data.final = ddply(data.raw,.(ParticipantNo,ExpPhase,AttendedColor,RewardedColor,MovedDots),summarize,
                  numtrials=length(which(Response!=99)), # number of trials per condition (anything that is not 99 or any other number that we're not using)
                  Hits=length(which(Response==1)), # hits: attended color moved, correct response
                  FAs=length(which(Response==2)), # false alarms: attended color did not move, (wrong) response
                  Misses=length(which(Response==0)), # misses: attended color moved, no response
                  CRs=length(which(Response==3)), # correct rejections: attended color did not move, no response
                  mean.RT=mean(RT,na.rm=TRUE)) # mean RT per condition


################################################################## Calculate accuracy and RTs per condition ###############################################################################################################################################################################################################

# Prepare the data------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### Calculate Hits and False alarms
# Hits are calculated for each participant in each condition on trials when they are attending the color that moved. 
# False alarms are  calculated for each participant in each condition on trials when they are attending the color that didn't move (the unattended color moved, but they responded)  
# Here we create the same number of hits & fas for each of the two conditions (moved attended or not)
data.final = ddply(data.final, .(ParticipantNo,ExpPhase,AttendedColor), transform, 
                 Hits = Hits[MovedDots==AttendedColor],
                 FAs = FAs[MovedDots!=AttendedColor])

# Keep only trials on which the attended color moved (we can do behavioral analysis only on those)
data.final = subset(data.final,MovedDots==AttendedColor)

### Calculate d'
# use loglinear transformation: add 0.5 to Hits, FAs, Misses, and CRs (Hautus, 1995, Behavior Research Methods, Instruments, & Computers),
# which is preferred over the 1/2N rule (Macmillan & Kaplan, 1985, Psychological Bulletin) because it results in less biased estimates of d'.
data.final =  ddply(data.final,.(ParticipantNo,ExpPhase,RewardedColor,AttendedColor,numtrials),summarise,
                    tot.Hits=Hits+.5, # hits
                    tot.FAs=FAs+.5, # false alarms
                    tot.Misses=(numtrials-Hits)+.5, # misses
                    tot.CRs=(numtrials-FAs)+.5, # correct rejections
                    Hit.Rate=tot.Hits/(tot.Hits+tot.Misses), # hit rate
                    FA.Rate=tot.FAs/(tot.FAs+tot.CRs), # false alarm rate
                    #dprime=qnorm(Hit.Rate)-qnorm(FA.Rate),
                    Hits.RTs=mean(mean.RT,na.rm=TRUE)) # mean RTs

# Calculate SDT indices with psycho
indices = psycho::dprime(data.final$tot.Hits, data.final$tot.FAs, data.final$tot.Misses, data.final$tot.CRs) 

data.final = cbind(data.final, indices) 
                      

### Create a final dataframe for accuracy and RTs analyses
# add a new variable specifying whether the participant is attending the high or Low_Rewed color
data.final$Condition = ifelse(data.final$RewardedColor==data.final$AttendedColor,"High_Rew","Low_Rew")
# make this variable a factor for further analyses
data.final$Condition = factor(data.final$Condition)

# Exclude subjects without EEG
missing_eeg = c(5,10,13,27,14)
data.final = data.final[!data.final$ParticipantNo %in% missing_eeg,]

```
## D prime
### Means - D prime - raw data

```{r, warning=FALSE, message=FALSE}
summary = ddply(data.final,.(ExpPhase,Condition),plyr::summarize,Mean=c(paste(round(mean(dprime, na.rm = TRUE), digits = 2), " [", round(hdi(dprime)[[1]], digits = 2), " ", round(hdi(dprime)[[2]], digits = 2), "]")))

names(summary) = c("Reward phase", "Reward probability", "Dprime")

# rename conditions
summary$`Reward phase` = recode(summary$`Reward phase`,
                                "Acq1" = "Acquisition1",
                                "Acq2" = "Acquisition2",
                                "Bsln1" = "Baseline1",
                                "Bsln2" = "Baseline2",
                                "Ext1" = "Extinction1",
                                "Ext2" = "Extinction2")

summary$`Reward probability` = recode(summary$`Reward probability`,
                           "High_Rew" = "High",
                           "Low_Rew" = "Low")

summary = as.data.frame(summary)

kable(summary, caption = "Dprime per condition")
```

### Plot

```{r, warning=FALSE, message=FALSE}
# # Plot FA rates------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] <- "Reward phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] <- "Reward probability"

# rename conditions
data.plot$`Reward phase` = recode(data.plot$`Reward phase`,
                                "Acq1" = "Acquisition1",
                                "Acq2" = "Acquisition2",
                                "Bsln1" = "Baseline1",
                                "Bsln2" = "Baseline2",
                                "Ext1" = "Extinction1",
                                "Ext2" = "Extinction2")

data.plot$`Reward probability` = recode(data.plot$`Reward probability`,
                                      "High_Rew" = "High",
                                      "Low_Rew" = "Low")
  # Pirate plot
  pirateplot(formula=dprime ~ `Reward phase` + `Reward probability`, # dependent~independent variables
             data=data.plot, # data frame
             main="Dprime", # main title
             ylim=c(-2,4), # y-axis: limits
             ylab="Dprime", # y-axis: label
             theme=0, # preset theme (0: use your own)
             point.col="black", # points: color
             point.o=.3, # points: opacity (0-1)
             avg.line.fun = median,
             avg.line.col="black", # average line: color
             avg.line.lwd=2, # average line: line width
             avg.line.o=1, # average line: opacity (0-1)
             bean.b.col="black", # bean border, color
             bean.lwd=0.6, # bean border, line width
             bean.lty=1, # bean border, line type (1: solid; 2:dashed; 3: dotted; ...)
             bean.b.o=0.3, # bean border, opacity (0-1)
             bean.f.col="gray", # bean filling, color
             bean.f.o=.1, # bean filling, opacity (0-1)
             cap.beans=FALSE, # max and min values of bean densities are capped at the limits found in the data
             gl.col="gray", # gridlines: color
             gl.lty=2, # gridlines: line type (1: solid; 2:dashed; 3: dotted; ...)
             cex.lab=1, # axis labels: size
             cex.axis=1, # axis numbers: size
             cex.names = 1,
             bty="l", # plot box type
             back.col="white") # background, color
  
```

\newpage

### Statistics 

```{r, warning=FALSE, message=FALSE}
# Set the working directory in order to load the models
# Set working directory
setwd(here("brms_models"))


model.full.Acc.dprime.split = readRDS("model.full.Acc.dprime.split.rds")
compare.waic.Acc.dprime.split = readRDS("compare.Acc.dprime.split.waic")
compare.Acc.dprime.split.waic.weights = readRDS("compare.Acc.dprime.split.waic.weights")
bR2.null.Acc.dprime.split = readRDS("bR2.null.Acc.dprime.split")
bR2.expphase.Acc.dprime.split = readRDS("bR2.expphase.Acc.dprime.split")
bR2.full.Acc.dprime.split = readRDS("bR2.full.Acc.dprime.split")
```

### Model comparison with WAIC

```{r, warning=FALSE, message=FALSE}
print(compare.waic.Acc.dprime.split)
```

### Bayesian R squared 

Null model
```{r, warning=FALSE, message=FALSE}
print(bR2.null.Acc.dprime.split)
```

Experiment phase model
```{r, warning=FALSE, message=FALSE}
print(bR2.expphase.Acc.dprime.split)
```

Full model
```{r, warning=FALSE, message=FALSE}
print(bR2.full.Acc.dprime.split)
```

### Checking the best model

Plotting the chains
```{r, warning=FALSE, message=FALSE}
# Plot chains
plot(model.full.Acc.dprime.split, pars = "^b_", ask = FALSE, N=6)
```

Summary of the best model 

```{r, warning=FALSE, message=FALSE}
# Summary of the best model
print(tidy(model.full.Acc.dprime.split, par_type = "non-varying"), digits = 1)
```

### Plotting the best model
#### Sample from the posterior
```{r, warning=FALSE, message=FALSE}
# Analyzing the posterior and differences between conditions

post = posterior_samples(model.full.Acc.dprime.split, "^b")


################################################ Baseline 1 ####

######### High reward
Baseline1_High = post[["b_Intercept"]]
######### Low reward
Baseline1_Low = post[["b_Intercept"]] + 
  post[["b_ConditionLow_Rew"]] 

################################################ Baseline 2 ####

######### High reward
Baseline2_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseBsln2"]] 
######### Low reward
Baseline2_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseBsln2"]] +
  post[["b_ConditionLow_Rew"]] +
  post[["b_ExpPhaseBsln2:ConditionLow_Rew"]]

################################################ Acquistion 1

######### High reward
Acquisition1_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq1"]] 
######### Low reward
Acquisition1_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq1"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseAcq1:ConditionLow_Rew"]]

################################################ Acquistion 2

######### High reward
Acquisition2_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq2"]] 
######### Low reward
Acquisition2_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq2"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseAcq2:ConditionLow_Rew"]]

################################################ Extinction 1

######### High reward
Extinction1_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt1"]] 
######### Low reward
Extinction1_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt1"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseExt1:ConditionLow_Rew"]]

################################################ Extinction 2

######### High reward
Extinction2_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt2"]] 
######### Low reward
Extinction2_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt2"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseExt2:ConditionLow_Rew"]]
```

```{r, warning=FALSE, message=FALSE}

# Data from the model

# make a data frame
posterior_conditions = melt(data.frame(Baseline1_High, Baseline2_High, Baseline1_Low, Baseline2_Low, Acquisition1_High, Acquisition1_Low, Acquisition2_High, Acquisition2_Low, Extinction1_High, Extinction1_Low, Extinction2_High, Extinction2_Low))

posterior_conditions =  posterior_conditions %>% separate(variable, c("Reward Phase", "Reward Probability"), "_", extra = "merge")

names(posterior_conditions)[3] = "dprime"

posterior_conditions$`Reward Probability` = recode(posterior_conditions$`Reward Probability`,
                                      "High" = "High reward",
                                      "Low" = "Low reward")

posterior_conditions$`Reward Phase` = recode(posterior_conditions$`Reward Phase`,
                                "Acquisition1" = "Training1",
                                "Acquisition2" = "Training2",
                                "Baseline1" = "Baseline1",
                                "Baseline1" = "Baseline2",
                                "Extinction1" = "Test1",
                                "Extinction2" = "Test2")

# Make a table with credible intervals
posterior_means = as.data.frame(c("Baseline1 High Reward", 
                                  "Baseline2 High Reward", 
                                  "Baseline1 Low Reward", 
                                  "Baseline2 Low Reward",
                                  "Acquisition1 High Reward", 
                                  "Acquisition2 High Reward",
                                  "Acquisition1 Low Reward", 
                                  "Acquisition2 Low Reward", 
                                  "Extinction1 High Reward", 
                                  "Extinction2 High Reward",
                                  "Extinction1 Low Reward",
                                  "Extinction2 Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$low_95_CI = c(round(hdi(Baseline1_High)[[1]], digits = 2),
                              round(hdi(Baseline2_High)[[1]], digits = 2),
                        round(hdi(Baseline1_Low)[[1]], digits = 2),
                        round(hdi(Baseline2_Low)[[1]], digits = 2),
                        round(hdi(Acquisition1_High)[[1]], digits = 2),
                        round(hdi(Acquisition2_High)[[1]], digits = 2),
                        round(hdi(Acquisition1_Low)[[1]], digits = 2),
                        round(hdi(Acquisition2_Low)[[1]], digits = 2),
                        round(hdi(Extinction1_High)[[1]], digits = 2),
                        round(hdi(Extinction2_High)[[1]], digits = 2),
                        round(hdi(Extinction1_Low)[[1]], digits = 2),
                        round(hdi(Extinction2_Low)[[1]], digits = 2))

posterior_means$high_95_CI = c(round(hdi(Baseline1_High)[[2]], digits = 2),
                              round(hdi(Baseline2_High)[[2]], digits = 2),
                        round(hdi(Baseline1_Low)[[2]], digits = 2),
                        round(hdi(Baseline2_Low)[[2]], digits = 2),
                        round(hdi(Acquisition1_High)[[2]], digits = 2),
                        round(hdi(Acquisition2_High)[[2]], digits = 2),
                        round(hdi(Acquisition1_Low)[[2]], digits = 2),
                        round(hdi(Acquisition2_Low)[[2]], digits = 2),
                        round(hdi(Extinction1_High)[[2]], digits = 2),
                        round(hdi(Extinction2_High)[[2]], digits = 2),
                        round(hdi(Extinction1_Low)[[2]], digits = 2),
                        round(hdi(Extinction2_Low)[[2]], digits = 2))

posterior_means$low_50_CI = c(round(hdi(Baseline1_High,0.5)[[1]], digits = 2),
                              round(hdi(Baseline2_High,0.5)[[1]], digits = 2),
                        round(hdi(Baseline1_Low,0.5)[[1]], digits = 2),
                        round(hdi(Baseline2_Low,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition1_High,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition2_High,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition1_Low,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition2_Low,0.5)[[1]], digits = 2),
                        round(hdi(Extinction1_High,0.5)[[1]], digits = 2),
                        round(hdi(Extinction2_High,0.5)[[1]], digits = 2),
                        round(hdi(Extinction1_Low,0.5)[[1]], digits = 2),
                        round(hdi(Extinction2_Low,0.5)[[1]], digits = 2))

posterior_means$high_50_CI = c(round(hdi(Baseline1_High,0.5)[[2]], digits = 2),
                              round(hdi(Baseline2_High,0.5)[[2]], digits = 2),
                        round(hdi(Baseline1_Low,0.5)[[2]], digits = 2),
                        round(hdi(Baseline2_Low,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition1_High,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition2_High,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition1_Low,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition2_Low,0.5)[[2]], digits = 2),
                        round(hdi(Extinction1_High,0.5)[[2]], digits = 2),
                        round(hdi(Extinction2_High,0.5)[[2]], digits = 2),
                        round(hdi(Extinction1_Low,0.5)[[2]], digits = 2),
                        round(hdi(Extinction2_Low,0.5)[[2]], digits = 2))


posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")

posterior_means$`Reward Probability` = recode(posterior_means$`Reward Probability`,
                                      "High Reward" = "High reward",
                                      "Low Reward" = "Low reward")

posterior_means$`Reward Phase` = recode(posterior_means$`Reward Phase`,
                                "Acquisition1" = "Training1",
                                "Acquisition2" = "Training2",
                                "Baseline1" = "Baseline1",
                                "Baseline1" = "Baseline2",
                                "Extinction1" = "Test1",
                                "Extinction2" = "Test2")

# Create this variable in order to have it for plotting (this is a quick hack: in plotting the CIs this variable is added and then subtracted)
posterior_means$`dprime` = c(1,1,1,1,1,1)


# Raw data
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] = "Reward Phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] = "Reward Probability"

# rename conditions
data.plot$`Reward Phase` = recode(data.plot$`Reward Phase`,
                                "Acq1" = "Training1",
                                "Acq2" = "Training2",
                                "Bsln1" = "Baseline1",
                                "Bsln2" = "Baseline2",
                                "Ext1" = "Test1",
                                "Ext2" = "Test2")

data.plot$`Reward Probability` = recode(data.plot$`Reward Probability`,
                                      "High_Rew" = "High reward",
                                      "Low_Rew" = "Low reward")


# Violin + the model
# tiff("dprime_split.tiff", units="in", width=16, height=5, res=800)

f.sup.a = ggplot(data=data.plot, aes(x=`Reward Phase`, y=`dprime`, label=`Reward Probability`)) + 
  # violin of the raw data
  geom_violin(data=data.plot, color ="#636363",trim = TRUE,alpha="0.2") +
  # individual participants for the raw data
  # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
  geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
  # mean of the model
  stat_summary(data = posterior_conditions, aes(x=`Reward Phase`, y=`dprime`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
  # 95 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`dprime`-`dprime`+low_95_CI, ymax=`dprime`-`dprime`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
  # 50 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`dprime`-`dprime`+low_50_CI, ymax=`dprime`-`dprime`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
  scale_x_discrete(limits=c("Baseline1","Baseline2", "Training1","Training2", "Test1","Test2")) +
  facet_grid(.~`Reward Probability`) + 
  scale_y_continuous(limits = c(-1,3),breaks=seq(-1,3,0.5)) +
  labs(title="Sensitivity dâ²", y = "Sensitivity dâ²") + 
  theme(
    axis.line = element_line(size=1, colour = "black"),
    panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
    text=element_text(colour="black", size = 14),
    axis.text.x=element_text(colour="black", size = 14),
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(size=16,colour = "black")) + 
  theme(strip.background =element_rect(fill="white")) + 
  theme(strip.text = element_text(size = 16))

f.sup.a  
# dev.off()



```

Table of means across conditions

```{r, warning=FALSE, message=FALSE}

# Make a table with conditions
posterior_means = as.data.frame(c("Baseline1 High Reward", 
                                  "Baseline1 Low Reward", 
                                  "Baseline2 High Reward", 
                                  "Baseline2 Low Reward",
                                  "Acquisition1 High Reward", 
                                  "Acquisition1 Low Reward",
                                  "Acquisition2 High Reward", 
                                  "Acquisition2 Low Reward", 
                                  "Extinction1 High Reward", 
                                  "Extinction1 Low Reward",
                                  "Extinction2 High Reward",
                                  "Extinction2 Low Reward"))

names(posterior_means)[1] = "Condition"

posterior_means$Mean = c(paste(round(mean(Baseline1_High), digits = 2), " [", round(hdi(Baseline1_High)[[1]], digits = 2), " ", round(hdi(Baseline1_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Baseline1_Low), digits = 2), " [", round(hdi(Baseline1_Low)[[1]], digits = 2), " ", round(hdi(Baseline1_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Baseline2_High), digits = 2), " [", round(hdi(Baseline2_High)[[1]], digits = 2), " ", round(hdi(Baseline2_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Baseline2_Low), digits = 2), " [", round(hdi(Baseline2_Low)[[1]], digits = 2), " ", round(hdi(Baseline2_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition1_High), digits = 2), " [", round(hdi(Acquisition1_High)[[1]], digits = 2), " ", round(hdi(Acquisition1_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition1_Low), digits = 2), " [", round(hdi(Acquisition1_Low)[[1]], digits = 2), " ", round(hdi(Acquisition1_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition2_High), digits = 2), " [", round(hdi(Acquisition2_High)[[1]], digits = 2), " ", round(hdi(Acquisition2_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition2_Low), digits = 2), " [", round(hdi(Acquisition2_Low)[[1]], digits = 2), " ", round(hdi(Acquisition2_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction1_High), digits = 2), " [", round(hdi(Extinction1_High)[[1]], digits = 2), " ", round(hdi(Extinction1_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction1_Low), digits = 2), " [", round(hdi(Extinction1_Low)[[1]], digits = 2), " ", round(hdi(Extinction1_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction2_High), digits = 2), " [", round(hdi(Extinction2_High)[[1]], digits = 2), " ", round(hdi(Extinction2_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction2_Low), digits = 2), " [", round(hdi(Extinction2_Low)[[1]], digits = 2), " ", round(hdi(Extinction2_Low)[[2]], digits = 2), "]"))

names(posterior_means)[2] = "Mean [HDI]"

posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")
                        
kable(posterior_means, caption = "Means per condition")

```

### Inference about the best model

Check the difference between baseline1 vs. baseline2 in high reward   

```{r, warning=FALSE, message=FALSE}
Diff_Bsln1_Bsln2_High = Baseline2_High - Baseline1_High
plotPost(Diff_Bsln1_Bsln2_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

Check the difference between baseline1 vs. baseline2 in low reward

```{r, warning=FALSE, message=FALSE}
Diff_Bsln1_Bsln2_Low = Baseline2_Low - Baseline1_Low
plotPost(Diff_Bsln1_Bsln2_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

Check the difference between baseline2 vs. acquisition1 in high reward   

```{r, warning=FALSE, message=FALSE}
Diff_Bsln2_Acq1_High = Baseline2_High - Acquisition1_High
plotPost(Diff_Bsln2_Acq1_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

Check the difference between baseline2 vs. acquisition1 in low reward

```{r, warning=FALSE, message=FALSE}
Diff_Bsln2_Acq1_Low = Acquisition1_Low - Baseline2_Low
plotPost(Diff_Bsln2_Acq1_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

## Reaction times

### Means - raw data

```{r, warning=FALSE, message=FALSE}
summary = ddply(data.final,.(ExpPhase,Condition),plyr::summarize,Mean=c(paste(round(mean(Hits.RTs, na.rm = TRUE), digits = 2), " [", round(hdi(Hits.RTs)[[1]], digits = 2), " ", round(hdi(Hits.RTs)[[2]], digits = 2), "]")))

names(summary) = c("Reward phase", "Reward probability", "Reaction times")

# rename conditions
summary$`Reward phase` = recode(summary$`Reward phase`,
                                "Acq1" = "Acquisition1",
                                "Acq2" = "Acquisition2",
                                "Bsln1" = "Baseline1",
                                "Bsln2" = "Baseline2",
                                "Ext1" = "Extinction1",
                                "Ext2" = "Extinction2")

summary$`Reward probability` = recode(summary$`Reward probability`,
                           "High_Rew" = "High",
                           "Low_Rew" = "Low")

summary = as.data.frame(summary)

kable(summary, caption = "Reaction times per condition")
```

### Plot

```{r, warning=FALSE, message=FALSE}
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] = "Reward phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] = "Reward probability"

# rename conditions
data.plot$`Reward phase` = recode(data.plot$`Reward phase`,
                                "Acq" = "Acquisition",
                                "Bsln" = "Baseline",
                                "Ext" = "Extinction")

data.plot$`Reward probability` = recode(data.plot$`Reward probability`,
                                      "High_Rew" = "High",
                                      "Low_Rew" = "Low")

# Pirate plot
  pirateplot(formula = Hits.RTs ~ `Reward phase` + `Reward probability`, # dependent~independent variables
             data=data.plot, # data frame
             main="Reaction times", # main title
             ylim=c(400,700), # y-axis: limits
             ylab="Reaction time", # y-axis: label
             theme=0, # preset theme (0: use your own)
             point.col="black", # points: color
             point.o=.3, # points: opacity (0-1)
             avg.line.fun = median,
             avg.line.col="black", # average line: color
             avg.line.lwd=2, # average line: line width
             avg.line.o=1, # average line: opacity (0-1)
             bean.b.col="black", # bean border, color
             bean.lwd=0.6, # bean border, line width
             bean.lty=1, # bean border, line type (1: solid; 2:dashed; 3: dotted; ...)
             bean.b.o=0.3, # bean border, opacity (0-1)
             bean.f.col="gray", # bean filling, color
             bean.f.o=.1, # bean filling, opacity (0-1)
             cap.beans=FALSE, # max and min values of bean densities are capped at the limits found in the data
             gl.col="gray", # gridlines: color
             gl.lty=2, # gridlines: line type (1: solid; 2:dashed; 3: dotted; ...)
             cex.lab=1, # axis labels: size
             cex.axis=1, # axis numbers: size
             cex.names = 1,
             bty="l", # plot box type
             back.col="white") # background, color
```

### Statistics
```{r, warning=FALSE, message=FALSE}
# Set the working directory in order to load the models
# Set working directory
setwd(here("brms_models"))

model.full.RT.split = readRDS("model.full.RT.split.rds")
compare.waic.RT.split = readRDS("compare.RT.split.waic")
compare.RT.split.waic.weights = readRDS("compare.RT.split.waic.weights")
bR2.null.RT.split = readRDS("bR2.null.RT.split")
bR2.expphase.RT.split = readRDS("bR2.expphase.RT.split")
bR2.full.RT.split = readRDS("bR2.full.RT.split")
```

### Model comparison with WAIC

```{r, warning=FALSE, message=FALSE}
print(compare.waic.RT.split)
```

### Bayesian R squared 

Null model
```{r, warning=FALSE, message=FALSE}
print(bR2.null.RT.split)
```

Experiment phase model
```{r, warning=FALSE, message=FALSE}
print(bR2.expphase.RT.split)
```

Full model
```{r, warning=FALSE, message=FALSE}
print(bR2.full.RT.split)
```

### Checking the best model

Plotting the chains
```{r, warning=FALSE, message=FALSE}
# Plot chains
plot(model.full.RT.split, pars = "^b_", ask = FALSE, N=6)
```

Summary of the best model 

```{r, warning=FALSE, message=FALSE}
# Summary of the best model
print(tidy(model.full.RT.split, par_type = "non-varying"), digits = 1)
```


### Plotting the best model
#### Sample from the posterior
```{r, warning=FALSE, message=FALSE}

# Analyzing the posterior and differences between conditions

post = posterior_samples(model.full.RT.split, "^b")


################################################ Baseline 1 ####

######### High reward
Baseline1_High = post[["b_Intercept"]]
######### Low reward
Baseline1_Low = post[["b_Intercept"]] + 
  post[["b_ConditionLow_Rew"]] 

################################################ Baseline 2 ####

######### High reward
Baseline2_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseBsln2"]] 
######### Low reward
Baseline2_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseBsln2"]] +
  post[["b_ConditionLow_Rew"]] +
  post[["b_ExpPhaseBsln2:ConditionLow_Rew"]]

################################################ Acquistion 1

######### High reward
Acquisition1_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq1"]] 
######### Low reward
Acquisition1_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq1"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseAcq1:ConditionLow_Rew"]]

################################################ Acquistion 2

######### High reward
Acquisition2_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq2"]] 
######### Low reward
Acquisition2_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseAcq2"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseAcq2:ConditionLow_Rew"]]

################################################ Extinction 1

######### High reward
Extinction1_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt1"]] 
######### Low reward
Extinction1_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt1"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseExt1:ConditionLow_Rew"]]

################################################ Extinction 2

######### High reward
Extinction2_High = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt2"]] 
######### Low reward
Extinction2_Low = post[["b_Intercept"]] + 
  post[["b_ExpPhaseExt2"]] + 
  post[["b_ConditionLow_Rew"]] + 
  post[["b_ExpPhaseExt2:ConditionLow_Rew"]]
```

```{r, warning=FALSE, message=FALSE}
# Data from the model

# make a data frame
posterior_conditions = melt(data.frame(Baseline1_High, Baseline2_High, Baseline1_Low, Baseline2_Low, Acquisition1_High, Acquisition1_Low, Acquisition2_High, Acquisition2_Low, Extinction1_High, Extinction1_Low, Extinction2_High, Extinction2_Low))

posterior_conditions =  posterior_conditions %>% separate(variable, c("Reward Phase", "Reward Probability"), "_", extra = "merge")

names(posterior_conditions)[3] = "Reaction time"

posterior_conditions$`Reward Probability` = recode(posterior_conditions$`Reward Probability`,
                                      "High" = "High reward",
                                      "Low" = "Low reward")

posterior_conditions$`Reward Phase` = recode(posterior_conditions$`Reward Phase`,
                                "Acquisition1" = "Training1",
                                "Acquisition2" = "Training2",
                                "Baseline1" = "Baseline1",
                                "Baseline1" = "Baseline2",
                                "Extinction1" = "Test1",
                                "Extinction2" = "Test2")

# Make a table with credible intervals
posterior_means = as.data.frame(c("Baseline1 High Reward", 
                                  "Baseline2 High Reward", 
                                  "Baseline1 Low Reward", 
                                  "Baseline2 Low Reward",
                                  "Acquisition1 High Reward", 
                                  "Acquisition2 High Reward",
                                  "Acquisition1 Low Reward", 
                                  "Acquisition2 Low Reward", 
                                  "Extinction1 High Reward", 
                                  "Extinction2 High Reward",
                                  "Extinction1 Low Reward",
                                  "Extinction2 Low Reward"))
names(posterior_means)[1] = "Condition"

posterior_means$low_95_CI = c(round(hdi(Baseline1_High)[[1]], digits = 2),
                              round(hdi(Baseline2_High)[[1]], digits = 2),
                        round(hdi(Baseline1_Low)[[1]], digits = 2),
                        round(hdi(Baseline2_Low)[[1]], digits = 2),
                        round(hdi(Acquisition1_High)[[1]], digits = 2),
                        round(hdi(Acquisition2_High)[[1]], digits = 2),
                        round(hdi(Acquisition1_Low)[[1]], digits = 2),
                        round(hdi(Acquisition2_Low)[[1]], digits = 2),
                        round(hdi(Extinction1_High)[[1]], digits = 2),
                        round(hdi(Extinction2_High)[[1]], digits = 2),
                        round(hdi(Extinction1_Low)[[1]], digits = 2),
                        round(hdi(Extinction2_Low)[[1]], digits = 2))

posterior_means$high_95_CI = c(round(hdi(Baseline1_High)[[2]], digits = 2),
                              round(hdi(Baseline2_High)[[2]], digits = 2),
                        round(hdi(Baseline1_Low)[[2]], digits = 2),
                        round(hdi(Baseline2_Low)[[2]], digits = 2),
                        round(hdi(Acquisition1_High)[[2]], digits = 2),
                        round(hdi(Acquisition2_High)[[2]], digits = 2),
                        round(hdi(Acquisition1_Low)[[2]], digits = 2),
                        round(hdi(Acquisition2_Low)[[2]], digits = 2),
                        round(hdi(Extinction1_High)[[2]], digits = 2),
                        round(hdi(Extinction2_High)[[2]], digits = 2),
                        round(hdi(Extinction1_Low)[[2]], digits = 2),
                        round(hdi(Extinction2_Low)[[2]], digits = 2))

posterior_means$low_50_CI = c(round(hdi(Baseline1_High,0.5)[[1]], digits = 2),
                              round(hdi(Baseline2_High,0.5)[[1]], digits = 2),
                        round(hdi(Baseline1_Low,0.5)[[1]], digits = 2),
                        round(hdi(Baseline2_Low,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition1_High,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition2_High,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition1_Low,0.5)[[1]], digits = 2),
                        round(hdi(Acquisition2_Low,0.5)[[1]], digits = 2),
                        round(hdi(Extinction1_High,0.5)[[1]], digits = 2),
                        round(hdi(Extinction2_High,0.5)[[1]], digits = 2),
                        round(hdi(Extinction1_Low,0.5)[[1]], digits = 2),
                        round(hdi(Extinction2_Low,0.5)[[1]], digits = 2))

posterior_means$high_50_CI = c(round(hdi(Baseline1_High,0.5)[[2]], digits = 2),
                              round(hdi(Baseline2_High,0.5)[[2]], digits = 2),
                        round(hdi(Baseline1_Low,0.5)[[2]], digits = 2),
                        round(hdi(Baseline2_Low,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition1_High,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition2_High,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition1_Low,0.5)[[2]], digits = 2),
                        round(hdi(Acquisition2_Low,0.5)[[2]], digits = 2),
                        round(hdi(Extinction1_High,0.5)[[2]], digits = 2),
                        round(hdi(Extinction2_High,0.5)[[2]], digits = 2),
                        round(hdi(Extinction1_Low,0.5)[[2]], digits = 2),
                        round(hdi(Extinction2_Low,0.5)[[2]], digits = 2))


posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")

posterior_means$`Reward Probability` = recode(posterior_means$`Reward Probability`,
                                      "High Reward" = "High reward",
                                      "Low Reward" = "Low reward")

posterior_means$`Reward Phase` = recode(posterior_means$`Reward Phase`,
                                "Acquisition1" = "Training1",
                                "Acquisition2" = "Training2",
                                "Baseline1" = "Baseline1",
                                "Baseline1" = "Baseline2",
                                "Extinction1" = "Test1",
                                "Extinction2" = "Test2")

# Create this variable in order to have it for plotting (this is a quick hack: in plotting the CIs this variable is added and then subtracted)
posterior_means$`Reaction time` = c(555,555,555,555,555,555)


# Raw data
# Prepare the dataset
data.plot = data.final

# rename variables
colnames(data.plot)[colnames(data.plot)=="ExpPhase"] = "Reward Phase"
colnames(data.plot)[colnames(data.plot)=="Condition"] = "Reward Probability"

# rename conditions
data.plot$`Reward Phase` = recode(data.plot$`Reward Phase`,
                                "Acq1" = "Training1",
                                "Acq2" = "Training2",
                                "Bsln1" = "Baseline1",
                                "Bsln2" = "Baseline2",
                                "Ext1" = "Test1",
                                "Ext2" = "Test2")

data.plot$`Reward Probability` = recode(data.plot$`Reward Probability`,
                                      "High_Rew" = "High reward",
                                      "Low_Rew" = "Low reward")

data.plot$`Reaction time` = data.plot$Hits.RTs


# Violin + the model
# tiff("RTs_split.tiff", units="in", width=16, height=5, res=800)

f.sup.b = ggplot(data=data.plot, aes(x=`Reward Phase`, y=`Reaction time`, label=`Reward Probability`)) + 
  # violin of the raw data
  geom_violin(data=data.plot, color ="#636363",trim = TRUE,alpha="0.2") +
  # individual participants for the raw data
  # geom_point(binaxis='y', stackdir='center', dotsize=0.5, alpha="0.2") + 
  geom_jitter(dotsize=0.9, alpha="0.6",width = 0.1,color="#bdbdbd")+
  # mean of the model
  stat_summary(data = posterior_conditions, aes(x=`Reward Phase`, y=`Reaction time`, group=`Reward Probability`),fun.y = mean, geom="line",size=0.8, colour = "#636363")+ 
  # 95 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`Reaction time`-`Reaction time`+low_95_CI, ymax=`Reaction time`-`Reaction time`+high_95_CI), size = 4, color = "#74a9cf", alpha = 1) +
  # 50 credible intervals of the model
  geom_linerange(data = posterior_means,width=.1, aes(ymin=`Reaction time`-`Reaction time`+low_50_CI, ymax=`Reaction time`-`Reaction time`+high_50_CI), size = 4, color = "#045a8d", alpha = 1) +
  scale_x_discrete(limits=c("Baseline1","Baseline2", "Training1","Training2", "Test1","Test2")) +
  facet_grid(.~`Reward Probability`) + 
  scale_y_continuous(limits =c(400,700),breaks=seq(400,700,50)) +
  labs(title="Reaction time", y = "Reaction time (ms)") + 
  theme(
    axis.line = element_line(size=1, colour = "black"),
    panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
    text=element_text(colour="black", size = 14),
    axis.text.x=element_text(colour="black", size = 14),
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(size=16,colour = "black")) + 
  theme(strip.background =element_rect(fill="white")) + 
  theme(strip.text = element_text(size = 16))
  
# dev.off()

f.sup.b

```


Table of means across conditions

```{r, warning=FALSE, message=FALSE}

# Make a table with conditions
posterior_means = as.data.frame(c("Baseline1 High Reward", 
                                  "Baseline1 Low Reward", 
                                  "Baseline2 High Reward", 
                                  "Baseline2 Low Reward",
                                  "Acquisition1 High Reward", 
                                  "Acquisition1 Low Reward",
                                  "Acquisition2 High Reward", 
                                  "Acquisition2 Low Reward", 
                                  "Extinction1 High Reward", 
                                  "Extinction1 Low Reward",
                                  "Extinction2 High Reward",
                                  "Extinction2 Low Reward"))

names(posterior_means)[1] = "Condition"

posterior_means$Mean = c(paste(round(mean(Baseline1_High), digits = 2), " [", round(hdi(Baseline1_High)[[1]], digits = 2), " ", round(hdi(Baseline1_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Baseline1_Low), digits = 2), " [", round(hdi(Baseline1_Low)[[1]], digits = 2), " ", round(hdi(Baseline1_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Baseline2_High), digits = 2), " [", round(hdi(Baseline2_High)[[1]], digits = 2), " ", round(hdi(Baseline2_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Baseline2_Low), digits = 2), " [", round(hdi(Baseline2_Low)[[1]], digits = 2), " ", round(hdi(Baseline2_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition1_High), digits = 2), " [", round(hdi(Acquisition1_High)[[1]], digits = 2), " ", round(hdi(Acquisition1_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition1_Low), digits = 2), " [", round(hdi(Acquisition1_Low)[[1]], digits = 2), " ", round(hdi(Acquisition1_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition2_High), digits = 2), " [", round(hdi(Acquisition2_High)[[1]], digits = 2), " ", round(hdi(Acquisition2_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Acquisition2_Low), digits = 2), " [", round(hdi(Acquisition2_Low)[[1]], digits = 2), " ", round(hdi(Acquisition2_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction1_High), digits = 2), " [", round(hdi(Extinction1_High)[[1]], digits = 2), " ", round(hdi(Extinction1_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction1_Low), digits = 2), " [", round(hdi(Extinction1_Low)[[1]], digits = 2), " ", round(hdi(Extinction1_Low)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction2_High), digits = 2), " [", round(hdi(Extinction2_High)[[1]], digits = 2), " ", round(hdi(Extinction2_High)[[2]], digits = 2), "]"),
                         paste(round(mean(Extinction2_Low), digits = 2), " [", round(hdi(Extinction2_Low)[[1]], digits = 2), " ", round(hdi(Extinction2_Low)[[2]], digits = 2), "]"))

names(posterior_means)[2] = "Mean [HDI]"

posterior_means =  posterior_means %>% separate(Condition, c("Reward Phase", "Reward Probability"), " ", extra = "merge")

kable(posterior_means, caption = "Means per condition")
```

### Inference about the best model

Check the difference between baseline1 vs. baseline2 in high reward   

```{r, warning=FALSE, message=FALSE}
Diff_Bsln1_Bsln2_High = Baseline2_High - Baseline1_High
plotPost(Diff_Bsln1_Bsln2_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

Check the difference between baseline1 vs. baseline2 in low reward

```{r, warning=FALSE, message=FALSE}
Diff_Bsln1_Bsln2_Low = Baseline2_Low - Baseline1_Low
plotPost(Diff_Bsln1_Bsln2_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

Check the difference between baseline2 vs. acquisition1 in high reward   

```{r, warning=FALSE, message=FALSE}
Diff_Bsln2_Acq1_High = Baseline2_High - Acquisition1_High
plotPost(Diff_Bsln2_Acq1_High, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

Check the difference between baseline2 vs. acquisition1 in low reward

```{r, warning=FALSE, message=FALSE}
Diff_Bsln2_Acq1_Low = Acquisition1_Low - Baseline2_Low
plotPost(Diff_Bsln2_Acq1_Low, xlab = "", col = "#b3cde0", showCurve = FALSE, cex = 1, compVal = 0)
```

# Creating figures for the manuscript
```{r, warning=FALSE, message=FALSE}
library(cowplot)
# Figure 2
# tiff("C:/Users/igrahek/Documents/Studies/SSVEP Reward - Soren & Antonio/Experiment 1/SSVEP_reward/figures/Figure2.tiff", units="in", width=15, height=10, res=300)
# 
# ggdraw() +
#     draw_plot(f.2.a, x = 0.03, y = 0.5, width = .45, height = .45) +
#     draw_plot(f.2.b, x = 0.53, y = .5, width = .45, height = .45) +
#     draw_plot(f.2.c, x = 0.03, y = 0, width = 0.45, height = 0.45) +
#     draw_plot(f.2.d, x = 0.53, y = 0, width = 0.45, height = 0.45) +
# 
#   draw_plot_label(label = c("A", "B", "C","D"), size = 20,
#                   x = c(0, 0.5, 0,0.5), y = c(1, 1, 0.5,0.5))
# 
# dev.off()
# 
# # Figure 1 Supplementary materials
# tiff("C:/Users/igrahek/Documents/Studies/SSVEP Reward - Soren & Antonio/Experiment 1/SSVEP_reward/figures/FigureSup1.tiff", units="in", width=15, height=10, res=300)
# 
# ggdraw() +
#     draw_plot(f.sup.a, x = 0.03, y = 0.5, width = .9, height = .45) +
#     draw_plot(f.sup.b, x = 0.03, y = 0, width = .9, height = .45) +
# 
#   draw_plot_label(label = c("A", "B"), size = 20,
#                   x = c(0, 0), y = c(1,0.5))
# 
# dev.off()


```